<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DOCTOR QUEST: MEDICAL SCHOOL</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--blue:#3498db;--green:#2ecc71;--red:#e74c3c;--yellow:#f1c40f;
--purple:#9b59b6;--cyan:#00e5ff;--gold:#f0c040;--orange:#e67e22;
--bg:#07070f;--surface:#0e0e1a;--text:#c8c8d8;
--wall:#1a1a30;--wall2:#22223a;
--mono:'Share Tech Mono',monospace;--display:'VT323',monospace;
}
html,body{overflow:hidden;width:100%;height:100%;background:var(--bg);font-family:var(--mono);color:var(--text);touch-action:none;overscroll-behavior:none;position:fixed}
canvas{display:block;image-rendering:pixelated;touch-action:none}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;font-family:var(--mono)}

/* HUD */
.hud{position:absolute;background:rgba(7,7,15,0.92);border:1px solid #1e1e38;
padding:4px 8px;border-radius:3px;pointer-events:none;z-index:100;
font-size:11px;letter-spacing:1px;backdrop-filter:blur(6px);
box-shadow:0 0 10px rgba(0,229,255,0.1)}
#hYear{top:8px;left:8px;color:#aaa}
#hLevel{top:8px;left:80px;color:#aaa}
#hScore{top:8px;right:50px;color:var(--gold)}
#hStreak{top:28px;right:8px;color:var(--orange);font-size:10px;display:none}
#hStreak.active{display:block;animation:streakGlow 2s infinite}

/* Save Indicator */
#saveIndicator{position:absolute;top:45px;left:8px;background:rgba(46,204,113,0.2);
border:1px solid var(--green);padding:4px 10px;border-radius:3px;
font-size:9px;color:var(--green);z-index:100;opacity:0;transition:opacity .3s;
display:flex;align-items:center;gap:5px}
#saveIndicator.show{opacity:1}

/* Progress Bar */
.prog-wrap{position:absolute;top:32px;left:8px;width:160px;height:4px;
background:#111;border:1px solid #222;border-radius:2px;z-index:100;
box-shadow:0 0 8px rgba(0,0,0,0.5)}
.prog-fill{height:100%;border-radius:2px;transition:width .4s;
background:linear-gradient(90deg,var(--blue),var(--cyan));
box-shadow:0 0 10px rgba(0,229,255,0.5)}

/* Question Dots */
.q-dots{position:absolute;top:42px;left:8px;display:flex;gap:5px;z-index:100}
.q-dot{width:8px;height:8px;border-radius:50%;border:1px solid #334;background:#111;transition:all .3s}
.q-dot.lit{background:var(--green);border-color:var(--green);box-shadow:0 0 8px var(--green);animation:dotPulse 1s infinite}

/* Narrator */
#narrator{position:absolute;top:12%;left:50%;transform:translateX(-50%);
background:rgba(10,10,20,0.94);border:1px solid #2a2a50;border-radius:4px;
padding:8px 20px;font-style:italic;font-size:12px;opacity:0;
transition:opacity .4s;z-index:99;pointer-events:none;max-width:85%;text-align:center;
color:#8080b0;box-shadow:0 0 20px rgba(0,200,255,0.15)}

/* Pause Button */
#pauseBtn{position:absolute;top:8px;right:8px;width:36px;height:36px;
background:rgba(14,14,26,0.92);border:1px solid #1e1e38;border-radius:50%;
color:#888;font-size:12px;display:flex;align-items:center;justify-content:center;
pointer-events:auto;z-index:200;cursor:pointer;transition:all .2s;
box-shadow:0 0 10px rgba(0,0,0,0.3)}
#pauseBtn:hover,#pauseBtn:active{color:#ccc;border-color:#444;transform:scale(1.05)}

/* Overlay Panels */
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(5,5,12,0.98);display:flex;flex-direction:column;
align-items:center;justify-content:center;z-index:300;
pointer-events:none;opacity:0;transition:opacity .35s;
backdrop-filter:blur(8px)}
.overlay.active{pointer-events:auto;opacity:1}

/* ====== QUESTION PANEL ====== */
#qPanel{z-index:500}
.q-box{background:linear-gradient(135deg,#0b0b18,#0f0f22);border:1px solid #252545;border-radius:12px;
padding:24px;max-width:92%;width:94%;max-height:90vh;overflow-y:auto;
box-shadow:0 0 60px rgba(0,229,255,0.15);position:relative;-webkit-overflow-scrolling:touch}
.q-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;
background:linear-gradient(90deg,var(--blue),var(--cyan),var(--blue));
background-size:200% 100%;animation:gradientShift 3s infinite;border-radius:12px 12px 0 0}

.q-title{font-family:var(--display);font-size:1.5rem;color:var(--cyan);
text-align:center;margin-bottom:14px;letter-spacing:2px}

.q-year-badge{display:inline-block;background:rgba(52,152,219,.15);
border:1px solid var(--blue);border-radius:4px;padding:4px 10px;
font-size:10px;color:var(--blue);letter-spacing:2px;margin-bottom:12px}

.q-text{font-size:14px;line-height:1.7;margin-bottom:16px;text-align:center;color:#ddd;
font-weight:500;padding:10px;background:rgba(0,0,0,0.3);border-radius:6px;
border-left:3px solid var(--cyan)}

.q-opts{display:flex;flex-direction:column;gap:10px;margin-bottom:14px}

/* ===== FIX: clickable answer buttons ===== */
.q-btn{
background:rgba(12,12,22,0.92);border:1px solid #222240;color:#888899;
padding:13px 16px;font-family:var(--mono);font-size:13px;letter-spacing:.5px;
border-radius:8px;cursor:pointer;transition:all .2s;width:100%;text-align:left;
pointer-events:auto;user-select:none;-webkit-user-select:none;
min-height:48px;/* touch-friendly target */
display:block;position:relative;z-index:1;
}
.q-btn:hover,.q-btn:active{background:#14142a;border-color:#3a3a60;color:#bbbbd0}
.q-btn.correct{background:rgba(46,204,113,.25)!important;border-color:var(--green)!important;color:#aaffbb!important}
.q-btn.wrong{background:rgba(231,76,60,.25)!important;border-color:var(--red)!important;color:#ffaaaa!important}
.q-btn:disabled{cursor:default}

/* Encouraging message popup */
#encourageMsg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);
background:linear-gradient(135deg,rgba(46,204,113,0.3),rgba(0,229,255,0.3));
border:2px solid var(--green);border-radius:16px;padding:20px 32px;
font-family:var(--display);font-size:2rem;color:#fff;text-align:center;
z-index:600;pointer-events:none;letter-spacing:2px;
text-shadow:0 0 20px var(--green);box-shadow:0 0 40px rgba(46,204,113,0.5);
transition:transform .3s cubic-bezier(0.34,1.56,0.64,1),opacity .3s}
#encourageMsg.pop{transform:translate(-50%,-50%) scale(1)}
#encourageMsg.fade{transform:translate(-50%,-50%) scale(0.8);opacity:0}

.q-feedback{font-size:14px;text-align:center;margin-top:10px;min-height:24px;font-weight:bold;padding:8px;border-radius:4px}
.q-feedback.correct{background:rgba(46,204,113,0.15);color:var(--green);border:1px solid var(--green)}
.q-feedback.wrong{background:rgba(231,76,60,0.15);color:var(--red);border:1px solid var(--red)}

.q-explanation{background:rgba(0,229,255,0.08);border:1px solid rgba(0,229,255,0.3);
border-radius:8px;padding:14px;margin-top:12px;font-size:13px;color:#88ccdd;
display:none;line-height:1.6;animation:fadeIn .4s ease}
.q-explanation.show{display:block}

#skipBtn{display:block;margin:12px auto 0;background:linear-gradient(135deg,#0d0d1e,#1a1a2e);
border:1px solid #1e1e3e;color:#5555aa;padding:9px 24px;font-family:var(--mono);
font-size:.75rem;letter-spacing:2px;border-radius:6px;cursor:pointer;
transition:all .2s;text-transform:uppercase;pointer-events:auto;min-height:44px}
#skipBtn:hover,#skipBtn:active{border-color:var(--blue);color:#8888cc}
#skipBtn:disabled{opacity:0.4;cursor:not-allowed}

.skip-bar-wrap{width:100%;height:3px;background:#111;border-radius:2px;margin-top:6px;overflow:hidden}
.skip-bar{height:100%;background:linear-gradient(90deg,var(--blue),var(--cyan));
border-radius:2px;transition:width .1s linear}

/* Pause Menu */
#pauseMenu h2{font-family:var(--display);font-size:clamp(2rem,6vw,3.2rem);color:var(--blue);
letter-spacing:2px;margin-bottom:16px}
.menu-btn{background:linear-gradient(135deg,rgba(12,12,22,0.92),rgba(20,20,35,0.92));
border:1px solid #2a2a4a;color:var(--text);
padding:13px 40px;font-family:var(--mono);font-size:.8rem;letter-spacing:2px;
border-radius:6px;cursor:pointer;transition:all .2s;width:85%;text-align:center;
text-transform:uppercase;margin:5px 0;pointer-events:auto;min-height:48px}
.menu-btn:hover,.menu-btn:active{background:#14142a;border-color:var(--blue);color:#dde;transform:translateY(-3px)}
.menu-btn.danger{border-color:#2a1010;color:#ff9999}
.menu-btn.danger:hover,.menu-btn.danger:active{border-color:var(--red);background:#1a0a0a}

/* Save Info in Pause */
.save-info{background:rgba(52,152,219,0.1);border:1px solid var(--blue);
border-radius:6px;padding:10px;margin:10px 0;width:85%;font-size:11px;color:#88ccdd}
.save-info-label{color:#aaa;margin-bottom:4px}
.save-info-value{color:var(--cyan);font-weight:bold}

/* Title Screen */
#title{position:fixed;top:0;left:0;width:100%;height:100%;
background:radial-gradient(ellipse at 50% 60%,#0c1824 0%,var(--bg) 70%);
display:flex;flex-direction:column;align-items:center;justify-content:center;
z-index:1000;transition:opacity .6s;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:20px}
#title.hidden{display:none}
.t-pre{font-family:var(--display);font-size:clamp(.8rem,2.5vw,1.1rem);color:#2a7a7a;
letter-spacing:5px;margin-bottom:8px;animation:pulse 4s infinite}
#mainTitle{font-family:var(--display);font-size:clamp(2.5rem,12vw,6rem);color:var(--cyan);
letter-spacing:3px;text-align:center;
text-shadow:0 0 25px rgba(0,229,255,.5),0 0 50px rgba(0,229,255,.25);
line-height:1;margin-bottom:6px;animation:glow 3s infinite}
.t-sub{font-family:var(--mono);font-size:11px;color:#2a7070;letter-spacing:3px;margin-bottom:20px}

/* Player Name Input */
.name-input-wrap{margin-bottom:15px;text-align:center}
.name-input-wrap label{display:block;color:#888;font-size:10px;letter-spacing:2px;margin-bottom:6px}
#playerNameInput{background:rgba(12,12,22,0.92);border:1px solid #2a2a4a;
color:var(--cyan);padding:10px 20px;font-family:var(--mono);font-size:13px;
letter-spacing:2px;border-radius:6px;text-align:center;width:220px;
text-transform:uppercase;pointer-events:auto;touch-action:auto}
#playerNameInput:focus{outline:none;border-color:var(--cyan);box-shadow:0 0 15px rgba(0,229,255,0.3)}

.t-btns{display:flex;flex-direction:column;align-items:center;gap:10px;width:100%}
.t-btn{background:linear-gradient(135deg,rgba(12,12,22,0.92),rgba(20,20,35,0.92));
border:1px solid #1e1e3e;color:#78cccc;
padding:13px 44px;font-family:var(--mono);font-size:.8rem;letter-spacing:2.5px;
border-radius:6px;cursor:pointer;transition:all .25s;width:88%;text-align:center;
text-transform:uppercase;pointer-events:auto;min-height:50px}
.t-btn:hover,.t-btn:active{background:#14141e;border-color:var(--cyan);color:#ddffff}
.t-btn.primary{border-color:#1a5060;color:#aaffe0}
.t-btn.continue{border-color:var(--green);color:var(--green);
box-shadow:0 0 20px rgba(46,204,113,0.3)}
.t-btn.lang{border-color:#3a3a7a;color:#ccccff}

/* Save Info Display */
#saveInfo{background:rgba(46,204,113,0.1);border:1px solid var(--green);
border-radius:6px;padding:10px 15px;margin-top:12px;font-size:10px;
color:var(--green);letter-spacing:1px;display:none;max-width:280px;text-align:center}
#saveInfo.show{display:block}

#credits{margin-top:16px;font-size:10px;color:#1e1e2e;letter-spacing:2px}

/* Year Complete */
#yearComp{z-index:450}
.yc-title{font-family:var(--display);font-size:clamp(2rem,7vw,4rem);
color:var(--green);letter-spacing:2px;text-align:center;
text-shadow:0 0 25px rgba(46,204,113,.6);margin-bottom:14px}
.yc-text{font-family:var(--mono);font-size:14px;color:#aaa;letter-spacing:1.5px;
text-align:center;max-width:90%;line-height:1.6;margin-bottom:28px}
.yc-btn{background:linear-gradient(135deg,rgba(12,12,22,0.92),rgba(20,20,35,0.92));
border:1px solid #2a4a2a;color:var(--green);
padding:15px 48px;font-family:var(--mono);font-size:.9rem;letter-spacing:2.5px;
border-radius:6px;cursor:pointer;transition:all .3s;text-transform:uppercase;
box-shadow:0 0 25px rgba(46,204,113,.3);width:85%;pointer-events:auto;min-height:54px}
.yc-btn:hover,.yc-btn:active{background:#0e1e0e;border-color:var(--green);color:#fff}

/* Certificate */
#certScreen{z-index:500;background:linear-gradient(135deg,#10101e,#07070f);overflow-y:auto}
.cert-wrap{background:#f5f0e8;border:6px solid #c0a020;border-radius:8px;
width:min(780px,95%);padding:30px 35px;text-align:center;
box-shadow:0 0 60px rgba(0,229,255,.4);position:relative;overflow:hidden;margin:20px auto}
.cert-border{position:absolute;inset:10px;border:2px solid #c0a020;border-radius:4px;pointer-events:none}
.cert-corner{position:absolute;width:40px;height:40px;border-color:#c0a020;border-style:solid}
.cert-corner.tl{top:14px;left:14px;border-width:2px 0 0 2px}
.cert-corner.tr{top:14px;right:14px;border-width:2px 2px 0 0}
.cert-corner.bl{bottom:14px;left:14px;border-width:0 0 2px 2px}
.cert-corner.br{bottom:14px;right:14px;border-width:0 2px 2px 0}
.cert-logo{font-size:44px;margin-bottom:4px}
.cert-school{font-family:var(--display);font-size:1.3rem;color:#1a3a5a;letter-spacing:3px;margin-bottom:6px}
.cert-presents{font-family:var(--mono);font-size:10px;color:#666;letter-spacing:2.5px;margin-bottom:4px}
.cert-name-area{border-bottom:2px solid #c0a020;border-top:2px solid #c0a020;
padding:10px 0;margin:12px 0;background:rgba(192,160,32,0.05)}
#certName{font-family:var(--display);font-size:1.9rem;color:#1a3a5a;letter-spacing:2.5px}
.cert-title-line{font-family:var(--display);font-size:1.3rem;color:#1a6a3a;letter-spacing:2.5px;margin:6px 0}
.cert-body{font-family:var(--mono);font-size:10px;color:#444;line-height:1.6;
margin:14px auto;max-width:520px;letter-spacing:.5px;padding:10px;
background:rgba(192,160,32,0.08);border-radius:4px}
.cert-date{font-family:var(--mono);font-size:10px;color:#666;letter-spacing:1.5px;margin-top:14px}
.cert-sigs{display:flex;flex-direction:column;gap:12px;margin-top:14px;padding-top:10px}
.cert-sig{text-align:center}
.cert-sig-line{border-bottom:1px solid #999;width:140px;margin:0 auto 4px}
.cert-sig-title{font-family:var(--mono);font-size:9px;color:#666;letter-spacing:1px}
.cert-btns{display:flex;flex-direction:column;gap:10px;margin-top:22px;justify-content:center;align-items:center}
.c-btn{background:linear-gradient(135deg,rgba(12,12,22,0.92),rgba(20,20,35,0.92));
border:1px solid #2a2a4a;color:var(--cyan);
padding:11px 28px;font-family:var(--mono);font-size:.75rem;letter-spacing:2px;
border-radius:6px;cursor:pointer;transition:all .2s;text-transform:uppercase;
pointer-events:auto;min-height:48px;min-width:200px}
.c-btn:hover,.c-btn:active{background:#14142a;border-color:var(--cyan);color:#fff}
.c-btn.dl{background:linear-gradient(135deg,var(--green),#27ae60);border-color:var(--green);color:#fff}

/* Achievement Popup */
.achievement-popup{position:fixed;top:80px;right:8px;background:linear-gradient(135deg,#1a1a2e,#0f0f1e);
border:1px solid var(--gold);border-radius:8px;padding:11px 14px;
z-index:600;display:none;box-shadow:0 0 30px rgba(240,192,64,0.3);pointer-events:none}
.achievement-popup.show{display:block;animation:achievementSlide .4s ease}
.ach-icon{font-size:22px;margin-right:8px;vertical-align:middle}
.ach-text{display:inline-block;vertical-align:middle}
.ach-title{color:var(--gold);font-size:10px;letter-spacing:1px;margin-bottom:2px}
.ach-desc{color:#aaa;font-size:10px}

/* ====== D-PAD (VIRTUAL JOYSTICK) ====== */
#dpad{position:fixed;bottom:20px;left:20px;z-index:200;
display:grid;grid-template-columns:56px 56px 56px;grid-template-rows:56px 56px 56px;gap:4px;
opacity:0.85;pointer-events:auto}
#dpad.hidden{display:none}
.dpad-btn{width:56px;height:56px;background:rgba(14,14,28,0.92);
border:1.5px solid rgba(52,152,219,0.6);border-radius:10px;
display:flex;align-items:center;justify-content:center;
color:rgba(0,229,255,0.9);font-size:22px;cursor:pointer;
transition:all .1s;-webkit-tap-highlight-color:transparent;
user-select:none;-webkit-user-select:none;touch-action:none}
.dpad-btn:active,.dpad-btn.pressed{background:rgba(52,152,219,0.3);border-color:var(--cyan);
box-shadow:0 0 12px rgba(0,229,255,0.4);transform:scale(0.93)}
.dpad-blank{background:transparent;border:none;pointer-events:none}

/* Scanlines */
#scanlines{position:fixed;top:0;left:0;width:100%;height:100%;
background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.04) 2px,rgba(0,0,0,.04) 4px);
pointer-events:none;z-index:600}

/* Animations */
@keyframes pulse{0%,100%{opacity:.85}50%{opacity:1}}
@keyframes glow{
0%,100%{text-shadow:0 0 25px rgba(0,229,255,.45),0 0 50px rgba(0,229,255,.2)}
50%{text-shadow:0 0 40px rgba(0,229,255,.7),0 0 80px rgba(0,229,255,.35)}
}
@keyframes dotPulse{0%,100%{box-shadow:0 0 8px var(--green)}50%{box-shadow:0 0 15px var(--green)}}
@keyframes streakGlow{0%,100%{box-shadow:0 0 10px var(--orange)}50%{box-shadow:0 0 20px var(--orange)}}
@keyframes gradientShift{0%{background-position:0%}50%{background-position:100%}100%{background-position:0%}}
@keyframes achievementSlide{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

@media(max-width:480px){
#mainTitle{font-size:clamp(2.2rem,14vw,4.5rem)}
.q-box{padding:16px}
.q-title{font-size:1.2rem}
.q-text{font-size:13px}
.q-btn{padding:12px 14px;font-size:12px}
#playerNameInput{width:180px;font-size:12px}
#dpad{bottom:12px;left:12px}
.dpad-btn{width:50px;height:50px;font-size:20px}
}
/* Landscape mobile: shrink dpad */
@media(max-height:500px){
#dpad{bottom:6px;left:6px}
.dpad-btn{width:44px;height:44px;font-size:18px}
}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
  <div id="hYear" class="hud">YEAR: <span id="vYear">1</span>/7</div>
  <div id="hLevel" class="hud">LEVEL: <span id="vLevel">1</span>/7</div>
  <div id="hScore" class="hud">SCORE: <span id="vScore">0</span></div>
  <div id="hStreak" class="hud">üî• <span id="vStreak">0</span></div>
  <div id="saveIndicator">üíæ SAVED</div>
  <div class="prog-wrap"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
  <div class="q-dots" id="qDots">
    <div class="q-dot" id="d0"></div>
    <div class="q-dot" id="d1"></div>
    <div class="q-dot" id="d2"></div>
  </div>
  <div id="narrator"></div>
  <button id="pauseBtn">‚ùô‚ùô</button>

  <!-- Encouraging message overlay -->
  <div id="encourageMsg"></div>

  <!-- Pause Menu -->
  <div class="overlay" id="pauseMenu">
    <h2 id="pTitle">PAUSED</h2>
    <div class="save-info">
      <div class="save-info-label">PLAYER</div>
      <div class="save-info-value" id="pausePlayerName">-</div>
      <div class="save-info-label" style="margin-top:8px">PROGRESS</div>
      <div class="save-info-value">Year <span id="pauseYear">1</span> ¬∑ Level <span id="pauseLevel">1</span></div>
      <div class="save-info-label" style="margin-top:8px">SCORE</div>
      <div class="save-info-value" id="pauseScore">0</div>
    </div>
    <button class="menu-btn" id="resumeBtn">RESUME</button>
    <button class="menu-btn" id="rstBtn">RESTART LEVEL</button>
    <button class="menu-btn danger" id="quitBtn">QUIT TO MENU</button>
  </div>

  <!-- Question Panel ‚Äî z-index 500 > dpad 200 -->
  <div class="overlay" id="qPanel" style="z-index:500">
    <div class="q-box">
      <div class="q-title" id="qTitle">MEDICAL QUESTION</div>
      <div style="text-align:center"><span class="q-year-badge" id="qBadge">YEAR 1 ‚Äî ANATOMY</span></div>
      <div class="q-text" id="qText"></div>
      <div class="q-opts" id="qOpts"></div>
      <div class="q-feedback" id="qFb"></div>
      <div class="q-explanation" id="qExplanation"></div>
      <button id="skipBtn">SKIP (10s)</button>
      <div class="skip-bar-wrap"><div class="skip-bar" id="skipBar" style="width:100%"></div></div>
    </div>
  </div>

  <!-- Year Complete -->
  <div class="overlay" id="yearComp" style="z-index:450">
    <div class="yc-title" id="ycTitle">YEAR 1 COMPLETE!</div>
    <div class="yc-text" id="ycText"></div>
    <button class="yc-btn" id="nextYrBtn">CONTINUE</button>
  </div>

  <!-- Certificate -->
  <div class="overlay" id="certScreen" style="z-index:500;background:linear-gradient(135deg,#10101e,#07070f)">
    <div class="cert-wrap">
      <div class="cert-border"></div>
      <div class="cert-corner tl"></div><div class="cert-corner tr"></div>
      <div class="cert-corner bl"></div><div class="cert-corner br"></div>
      <div class="cert-logo">‚öïÔ∏è</div>
      <div class="cert-school" id="certSchool">DOCTOR QUEST MEDICAL SCHOOL</div>
      <div class="cert-presents" id="certPresents">THIS CERTIFIES THAT</div>
      <div class="cert-name-area"><div id="certName">DR. [NAME]</div></div>
      <div class="cert-title-line" id="certTL">IS OFFICIALLY A DOCTOR OF MEDICINE</div>
      <div class="cert-body" id="certBody">Having successfully completed seven years of rigorous medical education.</div>
      <div class="cert-date" id="certDate"></div>
      <div class="cert-sigs">
        <div class="cert-sig"><div class="cert-sig-line"></div><div class="cert-sig-title" id="sigDean">DEAN OF MEDICINE</div></div>
        <div class="cert-sig"><div class="cert-sig-line"></div><div class="cert-sig-title" id="sigReg">MEDICAL REGISTRAR</div></div>
      </div>
      <div class="cert-btns">
        <button class="c-btn dl" id="dlBtn">üíæ SAVE CERTIFICATE</button>
        <button class="c-btn" id="playAgainBtn">üîÑ PLAY AGAIN</button>
      </div>
    </div>
  </div>

  <!-- Achievement Popup -->
  <div class="achievement-popup" id="achPopup">
    <span class="ach-icon">üèÜ</span>
    <div class="ach-text">
      <div class="ach-title">ACHIEVEMENT UNLOCKED!</div>
      <div class="ach-desc" id="achDesc">First Steps</div>
    </div>
  </div>
</div>

<!-- D-PAD (primary touch controls) -->
<div id="dpad" class="hidden">
  <div class="dpad-blank"></div>
  <button class="dpad-btn" id="dUp">‚Üë</button>
  <div class="dpad-blank"></div>
  <button class="dpad-btn" id="dLeft">‚Üê</button>
  <div class="dpad-blank dpad-center"></div>
  <button class="dpad-btn" id="dRight">‚Üí</button>
  <div class="dpad-blank"></div>
  <button class="dpad-btn" id="dDown">‚Üì</button>
  <div class="dpad-blank"></div>
</div>

<!-- Title Screen -->
<div id="title">
  <div class="t-pre" id="tPre">MEDICAL SCHOOL SIMULATION</div>
  <h1 id="mainTitle">DOCTOR QUEST</h1>
  <div class="t-sub" id="tSub">7 YEARS ¬∑ 7 LEVELS ¬∑ 3 QUESTIONS EACH</div>
  <div class="name-input-wrap">
    <label for="playerNameInput">ENTER YOUR NAME</label>
    <input type="text" id="playerNameInput" placeholder="DR. YOUR NAME" maxlength="20" autocomplete="off" autocorrect="off" spellcheck="false">
  </div>
  <div class="t-btns">
    <button class="t-btn primary" id="startBtn">üéì BEGIN MEDICAL SCHOOL</button>
    <button class="t-btn continue" id="continueBtn" style="display:none">üìÇ CONTINUE PROGRESS</button>
    <button class="t-btn lang" id="langBtn">üåê LANGUAGE: ENGLISH</button>
    <button class="t-btn" id="howBtn">‚ùì HOW TO PLAY</button>
  </div>
  <div id="saveInfo"></div>
  <div id="credits">üéì GRADUATES: <span id="gradCount">0</span></div>
</div>
<div id="scanlines"></div>

<script>
// ============================================================
// MEDICAL QUESTION DATABASE
// ============================================================
const DB = {
year1:{
  label:{en:"YEAR 1 ‚Äî ANATOMY & PHYSIOLOGY",fr:"ANN√âE 1 ‚Äî ANATOMIE & PHYSIOLOGIE"},
  qs:[
    {en:"What is the largest organ in the human body?",fr:"Quel est le plus grand organe du corps humain ?",a:{en:["Skin","Liver","Heart","Lung"],fr:["Peau","Foie","C≈ìur","Poumon"]},ca:0,exp:{en:"The skin covers approximately 20 square feet in adults and acts as a protective barrier.",fr:"La peau couvre environ 2 m¬≤ chez l'adulte et sert de barri√®re protectrice."}},
    {en:"How many bones are in the adult human body?",fr:"Combien d'os y a-t-il dans le corps humain adulte ?",a:{en:["206","300","172","250"],fr:["206","300","172","250"]},ca:0,exp:{en:"Adults have 206 bones. Babies are born with ~270 bones that fuse as they grow.",fr:"Les adultes ont 206 os. Les b√©b√©s naissent avec ~270 qui fusionnent en grandissant."}},
    {en:"Which blood type is the universal donor?",fr:"Quel groupe sanguin est le donneur universel ?",a:{en:["O-","A+","B-","AB+"],fr:["O-","A+","B-","AB+"]},ca:0,exp:{en:"O- blood lacks A, B, and Rh antigens, making it safe for all recipients in emergencies.",fr:"Le sang O- n'a pas d'antig√®nes A, B et Rh, s√ªr pour tous les receveurs."}},
    {en:"What is the normal resting heart rate for adults?",fr:"Quelle est la fr√©quence cardiaque normale au repos ?",a:{en:["60-100 bpm","40-60 bpm","110-130 bpm","80-150 bpm"],fr:["60-100 bpm","40-60 bpm","110-130 bpm","80-150 bpm"]},ca:0,exp:{en:"Normal resting heart rate is 60-100 beats per minute. Athletes may have lower rates.",fr:"La fr√©quence normale au repos est 60-100 bpm. Les athl√®tes peuvent avoir moins."}},
    {en:"Which organ produces insulin?",fr:"Quel organe produit l'insuline ?",a:{en:["Pancreas","Liver","Kidney","Spleen"],fr:["Pancr√©as","Foie","Rein","Rate"]},ca:0,exp:{en:"Insulin is produced by beta cells in the Islets of Langerhans within the pancreas.",fr:"L'insuline est produite par les cellules b√™ta des √Ælots de Langerhans du pancr√©as."}},
    {en:"What is the longest bone in the human body?",fr:"Quel est l'os le plus long du corps humain ?",a:{en:["Femur","Tibia","Fibula","Humerus"],fr:["F√©mur","Tibia","Fibula","Hum√©rus"]},ca:0,exp:{en:"The femur (thigh bone) is both the longest and strongest bone in the human body.",fr:"Le f√©mur est l'os le plus long et le plus solide du corps humain."}},
    {en:"How many chambers does the human heart have?",fr:"Combien de cavit√©s a le c≈ìur humain ?",a:{en:["4","2","3","6"],fr:["4","2","3","6"]},ca:0,exp:{en:"The heart has 4 chambers: right and left atria, and right and left ventricles.",fr:"Le c≈ìur a 4 cavit√©s : les oreillettes droite/gauche et les ventricules droite/gauche."}},
    {en:"What is the functional unit of the kidney?",fr:"Quelle est l'unit√© fonctionnelle du rein ?",a:{en:["Nephron","Neuron","Alveolus","Hepatocyte"],fr:["N√©phron","Neurone","Alv√©ole","H√©patocyte"]},ca:0,exp:{en:"Each kidney contains about 1 million nephrons responsible for filtering blood.",fr:"Chaque rein contient environ 1 million de n√©phrons pour filtrer le sang."}},
    {en:"Which gas do red blood cells primarily carry?",fr:"Quel gaz les globules rouges transportent-ils principalement ?",a:{en:["Oxygen","Carbon dioxide","Nitrogen","Argon"],fr:["Oxyg√®ne","Dioxyde de carbone","Azote","Argon"]},ca:0,exp:{en:"Red blood cells carry oxygen from the lungs to body tissues via hemoglobin.",fr:"Les globules rouges transportent l'oxyg√®ne des poumons aux tissus via l'h√©moglobine."}},
    {en:"What protein carries oxygen in red blood cells?",fr:"Quelle prot√©ine transporte l'oxyg√®ne dans les globules rouges ?",a:{en:["Hemoglobin","Albumin","Fibrinogen","Myosin"],fr:["H√©moglobine","Albumine","Fibrinog√®ne","Myosine"]},ca:0,exp:{en:"Hemoglobin binds oxygen in the lungs and releases it in the tissues. It also gives blood its red color.",fr:"L'h√©moglobine lie l'oxyg√®ne et donne sa couleur rouge au sang."}},
    {en:"Which part of the brain controls breathing?",fr:"Quelle partie du cerveau contr√¥le la respiration ?",a:{en:["Medulla oblongata","Cerebellum","Cerebrum","Thalamus"],fr:["Bulbe rachidien","Cervelet","Cerveau","Thalamus"]},ca:0,exp:{en:"The medulla oblongata controls automatic functions like breathing, heartbeat, and blood pressure.",fr:"Le bulbe rachidien contr√¥le les fonctions automatiques comme la respiration."}},
    {en:"What connects muscle to bone?",fr:"Quelle structure relie le muscle √† l'os ?",a:{en:["Tendon","Ligament","Cartilage","Fascia"],fr:["Tendon","Ligament","Cartilage","Fascia"]},ca:0,exp:{en:"Tendons connect muscle to bone. Ligaments connect bone to bone at joints.",fr:"Les tendons relient le muscle √† l'os. Les ligaments relient les os entre eux."}},
    {en:"Which organ produces bile?",fr:"Quel organe produit la bile ?",a:{en:["Liver","Gallbladder","Pancreas","Duodenum"],fr:["Foie","V√©sicule biliaire","Pancr√©as","Duod√©num"]},ca:0,exp:{en:"The liver produces bile; the gallbladder stores and concentrates it until needed for digestion.",fr:"Le foie produit la bile ; la v√©sicule la stocke jusqu'√† la digestion."}},
    {en:"How many lobes does the right lung have?",fr:"Combien de lobes le poumon droit a-t-il ?",a:{en:["3","2","4","1"],fr:["3","2","4","1"]},ca:0,exp:{en:"Right lung has 3 lobes (upper, middle, lower). Left lung has only 2 to make room for the heart.",fr:"Le poumon droit a 3 lobes ; le gauche en a 2 pour laisser place au c≈ìur."}},
    {en:"Which vitamin is produced by skin under sunlight?",fr:"Quelle vitamine est produite par la peau sous le soleil ?",a:{en:["Vitamin D","Vitamin C","Vitamin A","Vitamin K"],fr:["Vitamine D","Vitamine C","Vitamine A","Vitamine K"]},ca:0,exp:{en:"UV rays convert 7-dehydrocholesterol in skin to Vitamin D3, essential for calcium absorption.",fr:"Les UV convertissent le 7-d√©hydrocholest√©rol en vitamine D3, essentielle au calcium."}}
  ]
},
year2:{
  label:{en:"YEAR 2 ‚Äî BIOCHEMISTRY & HISTOLOGY",fr:"ANN√âE 2 ‚Äî BIOCHIMIE & HISTOLOGIE"},
  qs:[
    {en:"What is the powerhouse of the cell?",fr:"Quel est le moteur de la cellule ?",a:{en:["Mitochondria","Nucleus","Ribosome","Golgi apparatus"],fr:["Mitochondries","Noyau","Ribosome","Appareil de Golgi"]},ca:0,exp:{en:"Mitochondria produce ATP through cellular respiration (oxidative phosphorylation).",fr:"Les mitochondries produisent l'ATP par respiration cellulaire."}},
    {en:"Which macromolecule carries genetic information?",fr:"Quelle macromol√©cule porte l'information g√©n√©tique ?",a:{en:["DNA","RNA","Protein","Lipid"],fr:["ADN","ARN","Prot√©ine","Lipide"]},ca:0,exp:{en:"DNA (deoxyribonucleic acid) stores the complete genetic blueprint in the cell nucleus.",fr:"L'ADN stocke l'information g√©n√©tique dans le noyau."}},
    {en:"What enzyme unwinds DNA for replication?",fr:"Quelle enzyme d√©roule l'ADN pour la r√©plication ?",a:{en:["Helicase","Polymerase","Ligase","Topoisomerase"],fr:["H√©licase","Polym√©rase","Ligase","Topoisom√©rase"]},ca:0,exp:{en:"Helicase breaks hydrogen bonds between base pairs to unwind the DNA double helix at replication forks.",fr:"L'h√©licase brise les liaisons hydrog√®ne pour d√©rouler l'ADN."}},
    {en:"Which cells produce antibodies?",fr:"Quelles cellules produisent des anticorps ?",a:{en:["Plasma cells","T lymphocytes","NK cells","Macrophages"],fr:["Plasmocytes","Lymphocytes T","Cellules NK","Macrophages"]},ca:0,exp:{en:"Plasma cells are fully differentiated B lymphocytes that secrete large quantities of antibodies.",fr:"Les plasmocytes sont des lymphocytes B diff√©renci√©s qui s√©cr√®tent des anticorps."}},
    {en:"What is the building block of proteins?",fr:"Quel est le composant de base des prot√©ines ?",a:{en:["Amino acids","Nucleotides","Fatty acids","Monosaccharides"],fr:["Acides amin√©s","Nucl√©otides","Acides gras","Monosaccharides"]},ca:0,exp:{en:"There are 20 standard amino acids that combine via peptide bonds to form all proteins.",fr:"20 acides amin√©s se combinent par des liaisons peptidiques pour former toutes les prot√©ines."}},
    {en:"How many ATP are produced from one glucose molecule?",fr:"Combien d'ATP sont produits par une mol√©cule de glucose ?",a:{en:["30-32 ATP","2 ATP","8 ATP","50 ATP"],fr:["30-32 ATP","2 ATP","8 ATP","50 ATP"]},ca:0,exp:{en:"Complete aerobic oxidation of glucose yields 30-32 ATP via glycolysis, Krebs cycle, and oxidative phosphorylation.",fr:"L'oxydation compl√®te du glucose produit 30-32 ATP via la glycolyse et le cycle de Krebs."}},
    {en:"What is the main intracellular cation?",fr:"Quel est le principal cation intracellulaire ?",a:{en:["Potassium (K+)","Sodium (Na+)","Calcium (Ca2+)","Magnesium (Mg2+)"],fr:["Potassium (K+)","Sodium (Na+)","Calcium (Ca2+)","Magn√©sium (Mg2+)"]},ca:0,exp:{en:"K+ concentration is high inside cells; Na+ is high outside. This gradient drives action potentials.",fr:"K+ est √©lev√© √† l'int√©rieur des cellules ; Na+ est √©lev√© √† l'ext√©rieur."}},
    {en:"Which cells are CNS phagocytes?",fr:"Quelles cellules sont les phagocytes du SNC ?",a:{en:["Microglia","Astrocytes","Oligodendrocytes","Schwann cells"],fr:["Microglie","Astrocytes","Oligodendrocytes","Cellules de Schwann"]},ca:0,exp:{en:"Microglia are the resident macrophages of the CNS, patrolling for pathogens and clearing debris.",fr:"La microglie sont les macrophages r√©sidents du SNC."}},
    {en:"What tissue type forms glands?",fr:"Quel type de tissu forme les glandes ?",a:{en:["Epithelial","Connective","Muscle","Nervous"],fr:["√âpith√©lial","Conjonctif","Musculaire","Nerveux"]},ca:0,exp:{en:"Epithelial tissue forms glands, lines body cavities, and covers body surfaces.",fr:"Le tissu √©pith√©lial forme les glandes et tapisse les cavit√©s du corps."}},
    {en:"What is albumin's primary role?",fr:"Quel est le r√¥le principal de l'albumine ?",a:{en:["Maintain oncotic pressure","Carry oxygen","Clotting factor","Fight infection"],fr:["Maintenir la pression oncotique","Transporter l'oxyg√®ne","Facteur de coagulation","Lutter contre l'infection"]},ca:0,exp:{en:"Albumin is the major plasma protein that maintains oncotic pressure, keeping fluid in blood vessels.",fr:"L'albumine maintient la pression oncotique pour garder les liquides dans les vaisseaux."}},
    {en:"Which bond holds the DNA double helix together?",fr:"Quel type de liaison maintient la double h√©lice de l'ADN ?",a:{en:["Hydrogen bonds","Covalent bonds","Ionic bonds","Van der Waals"],fr:["Liaisons hydrog√®ne","Liaisons covalentes","Liaisons ioniques","Forces de Van der Waals"]},ca:0,exp:{en:"Hydrogen bonds form between complementary base pairs (A-T: 2 bonds, G-C: 3 bonds).",fr:"Les liaisons hydrog√®ne se forment entre les paires de bases compl√©mentaires."}},
    {en:"Which organelle packages and ships proteins?",fr:"Quel organite emballe et exp√©die les prot√©ines ?",a:{en:["Golgi apparatus","Ribosome","Mitochondria","Lysosome"],fr:["Appareil de Golgi","Ribosome","Mitochondries","Lysosome"]},ca:0,exp:{en:"The Golgi apparatus modifies, packages, and ships proteins to their final destinations.",fr:"L'appareil de Golgi modifie, emballe et exp√©die les prot√©ines."}},
    {en:"Which skin layer contains melanocytes?",fr:"Quelle couche de peau contient les m√©lanocytes ?",a:{en:["Stratum basale","Stratum corneum","Stratum granulosum","Stratum spinosum"],fr:["Stratum basale","Stratum corneum","Stratum granulosum","Stratum spinosum"]},ca:0,exp:{en:"Melanocytes reside in the stratum basale and produce melanin to protect against UV radiation.",fr:"Les m√©lanocytes produisent la m√©lanine dans le stratum basale."}},
    {en:"What is the end product of the Krebs cycle?",fr:"Quel est le produit final du cycle de Krebs ?",a:{en:["CO2, NADH, FADH2","Glucose","Pyruvate","Lactate"],fr:["CO2, NADH, FADH2","Glucose","Pyruvate","Lactate"]},ca:0,exp:{en:"The Krebs cycle produces CO2 (waste), NADH and FADH2 (electron carriers for the ETC).",fr:"Le cycle de Krebs produit CO2, NADH et FADH2 pour la cha√Æne respiratoire."}},
    {en:"What process do cells use to engulf large particles?",fr:"Quel processus les cellules utilisent pour ing√©rer de grandes particules ?",a:{en:["Phagocytosis","Pinocytosis","Exocytosis","Transcytosis"],fr:["Phagocytose","Pinocytose","Exocytose","Transcytose"]},ca:0,exp:{en:"Phagocytosis ('cell eating') engulfs large particles like bacteria. Pinocytosis engulfs fluid.",fr:"La phagocytose ing√®re de grandes particules comme les bact√©ries."}}
  ]
},
year3:{
  label:{en:"YEAR 3 ‚Äî PATHOLOGY & MICROBIOLOGY",fr:"ANN√âE 3 ‚Äî PATHOLOGIE & MICROBIOLOGIE"},
  qs:[
    {en:"What is the most common cause of community-acquired pneumonia?",fr:"Quelle est la cause la plus fr√©quente de la pneumonie communautaire ?",a:{en:["Streptococcus pneumoniae","E. coli","Staphylococcus aureus","Klebsiella"],fr:["Streptocoque pneumoniae","E. coli","Staphylocoque dor√©","Klebsiella"]},ca:0,exp:{en:"S. pneumoniae (pneumococcus) is the most common bacterial cause of CAP in adults.",fr:"S. pneumoniae est la cause bact√©rienne la plus fr√©quente de pneumonie communautaire."}},
    {en:"Which bacterium causes tuberculosis?",fr:"Quelle bact√©rie cause la tuberculose ?",a:{en:["Mycobacterium tuberculosis","Streptococcus","E. coli","Salmonella"],fr:["Mycobacterium tuberculosis","Streptocoque","E. coli","Salmonelle"]},ca:0,exp:{en:"M. tuberculosis is an acid-fast bacillus that primarily infects the lungs and is spread via aerosols.",fr:"M. tuberculosis est un bacille acido-alcoolo-r√©sistant qui infecte principalement les poumons."}},
    {en:"Which cell type dominates in chronic inflammation?",fr:"Quel type cellulaire domine l'inflammation chronique ?",a:{en:["Macrophage","Neutrophil","Eosinophil","Basophil"],fr:["Macrophage","Neutrophile","√âosinophile","Basophile"]},ca:0,exp:{en:"Macrophages dominate chronic inflammation. Neutrophils are the first responders in acute inflammation.",fr:"Les macrophages dominent l'inflammation chronique ; les neutrophiles l'aigu√´."}},
    {en:"Which virus causes AIDS?",fr:"Quel virus cause le SIDA ?",a:{en:["HIV","HPV","HBV","HSV"],fr:["VIH","VPH","VHB","VHS"]},ca:0,exp:{en:"HIV (Human Immunodeficiency Virus) destroys CD4+ T cells, leading to immunodeficiency.",fr:"Le VIH d√©truit les lymphocytes T CD4+, causant l'immunod√©ficience."}},
    {en:"What type of necrosis occurs in myocardial infarction?",fr:"Quelle n√©crose survient dans l'infarctus du myocarde ?",a:{en:["Coagulative necrosis","Liquefactive necrosis","Caseous necrosis","Fat necrosis"],fr:["N√©crose coagulante","N√©crose liqu√©fiante","N√©crose cas√©euse","N√©crose graisseuse"]},ca:0,exp:{en:"Coagulative necrosis preserves cell outlines. It is typical of ischemic injury in solid organs like the heart.",fr:"La n√©crose coagulante est typique de l'isch√©mie des organes solides comme le c≈ìur."}},
    {en:"Which organism causes malaria?",fr:"Quel organisme cause le paludisme ?",a:{en:["Plasmodium","Trypanosoma","Leishmania","Giardia"],fr:["Plasmodium","Trypanosoma","Leishmania","Giardia"]},ca:0,exp:{en:"Plasmodium (P. falciparum, P. vivax, etc.) is transmitted by female Anopheles mosquitoes.",fr:"Plasmodium est transmis par les moustiques Anoph√®les femelles."}},
    {en:"What is the most common type of skin cancer?",fr:"Quel est le type de cancer de peau le plus courant ?",a:{en:["Basal cell carcinoma","Melanoma","Squamous cell carcinoma","Merkel cell carcinoma"],fr:["Carcinome basocellulaire","M√©lanome","Carcinome √©pidermo√Øde","Carcinome de Merkel"]},ca:0,exp:{en:"BCC is the most common skin cancer and rarely metastasizes. Melanoma is rarest but most deadly.",fr:"Le CBC est le plus courant mais rarement m√©tastatique. Le m√©lanome est le plus dangereux."}},
    {en:"Which antibody is produced first in a primary immune response?",fr:"Quel anticorps est produit en premier dans la r√©ponse immunitaire primaire ?",a:{en:["IgM","IgG","IgA","IgE"],fr:["IgM","IgG","IgA","IgE"]},ca:0,exp:{en:"IgM is produced first (primary response). IgG appears later and provides long-term immunity.",fr:"L'IgM est produit en premier. L'IgG assure l'immunit√© √† long terme."}},
    {en:"What is cancer spread to distant sites called?",fr:"Comment appelle-t-on la propagation du cancer √† distance ?",a:{en:["Metastasis","Invasion","Hyperplasia","Dysplasia"],fr:["M√©tastase","Invasion","Hyperplasie","Dysplasie"]},ca:0,exp:{en:"Metastasis is the spread of cancer cells via blood or lymphatic vessels to distant organs.",fr:"La m√©tastase est la propagation des cellules canc√©reuses √† des organes distants."}},
    {en:"What is programmed cell death called?",fr:"Qu'est-ce que la mort cellulaire programm√©e ?",a:{en:["Apoptosis","Necrosis","Autophagy","Senescence"],fr:["Apoptose","N√©crose","Autophagie","S√©nescence"]},ca:0,exp:{en:"Apoptosis is controlled cell death used in development, immune function, and tumor suppression.",fr:"L'apoptose est une mort cellulaire contr√¥l√©e, essentielle au d√©veloppement et √† l'immunit√©."}},
    {en:"What type of hypersensitivity is anaphylaxis?",fr:"Quel type d'hypersensibilit√© est l'anaphylaxie ?",a:{en:["Type I (IgE-mediated)","Type II","Type III","Type IV"],fr:["Type I (m√©di√©e par IgE)","Type II","Type III","Type IV"]},ca:0,exp:{en:"Type I hypersensitivity is IgE-mediated. It causes mast cell degranulation and histamine release.",fr:"Le type I est m√©di√© par les IgE : d√©granulation des mastocytes et lib√©ration d'histamine."}},
    {en:"What is the most common cause of UTIs?",fr:"Quelle est la cause la plus fr√©quente des infections urinaires ?",a:{en:["E. coli","Staphylococcus","Streptococcus","Klebsiella"],fr:["E. coli","Staphylocoque","Streptocoque","Klebsiella"]},ca:0,exp:{en:"E. coli from the GI tract causes over 80% of urinary tract infections due to ascending migration.",fr:"E. coli cause plus de 80% des infections urinaires par migration ascendante."}},
    {en:"Which virus causes chickenpox and can reactivate as shingles?",fr:"Quel virus cause la varicelle et peut se r√©activer en zona ?",a:{en:["Varicella-zoster virus","Influenza virus","Measles virus","Mumps virus"],fr:["Virus varicelle-zona","Virus influenza","Virus de la rougeole","Virus des oreillons"]},ca:0,exp:{en:"VZV lies dormant in dorsal root ganglia after primary infection and reactivates as shingles (herpes zoster).",fr:"Le VZV reste dormant dans les ganglions et se r√©active en zona."}},
    {en:"Which fungus most commonly causes oral thrush?",fr:"Quel champignon cause le plus souvent le muguet oral ?",a:{en:["Candida albicans","Aspergillus fumigatus","Cryptococcus","Histoplasma"],fr:["Candida albicans","Aspergillus fumigatus","Cryptococcus","Histoplasma"]},ca:0,exp:{en:"C. albicans is part of normal flora but overgrows in immunocompromised patients or after antibiotics.",fr:"C. albicans est une flore normale qui prolif√®re chez les immunod√©prim√©s."}},
    {en:"What bacterium causes peptic ulcers?",fr:"Quelle bact√©rie cause les ulc√®res peptiques ?",a:{en:["Helicobacter pylori","E. coli","Salmonella","Shigella"],fr:["Helicobacter pylori","E. coli","Salmonelle","Shigella"]},ca:0,exp:{en:"H. pylori is a spiral-shaped bacterium that survives stomach acid and causes chronic gastritis and ulcers.",fr:"H. pylori survit √† l'acide gastrique et cause la gastrite chronique et les ulc√®res."}}
  ]
},
year4:{
  label:{en:"YEAR 4 ‚Äî PHARMACOLOGY & DIAGNOSTICS",fr:"ANN√âE 4 ‚Äî PHARMACOLOGIE & DIAGNOSTIC"},
  qs:[
    {en:"What is aspirin's mechanism of action?",fr:"Quel est le m√©canisme d'action de l'aspirine ?",a:{en:["COX inhibitor","ACE inhibitor","Beta blocker","Calcium channel blocker"],fr:["Inhibiteur COX","Inhibiteur ACE","B√™ta-bloquant","Bloqueur calcique"]},ca:0,exp:{en:"Aspirin irreversibly inhibits COX-1 and COX-2, preventing prostaglandin and thromboxane synthesis.",fr:"L'aspirine inhibe irr√©versiblement COX-1 et COX-2, bloquant la synth√®se des prostaglandines."}},
    {en:"What reverses warfarin anticoagulation?",fr:"Quel est l'antidote de la warfarine ?",a:{en:["Vitamin K","Protamine sulfate","Naloxone","Flumazenil"],fr:["Vitamine K","Sulfate de protamine","Naloxone","Flumaz√©nil"]},ca:0,exp:{en:"Vitamin K reverses warfarin by promoting synthesis of clotting factors II, VII, IX, X.",fr:"La vitamine K inverse la warfarine en favorisant la synth√®se des facteurs de coagulation."}},
    {en:"What is the first-line treatment for anaphylaxis?",fr:"Quel m√©dicament traite l'anaphylaxie en premi√®re intention ?",a:{en:["Epinephrine (IM)","Antihistamines","Corticosteroids","Oxygen only"],fr:["√âpin√©phrine (IM)","Antihistaminiques","Corticost√©ro√Ødes","Oxyg√®ne seulement"]},ca:0,exp:{en:"IM epinephrine is first-line for anaphylaxis. It reverses bronchoconstriction and vasodilation.",fr:"L'√©pin√©phrine IM est de premi√®re intention. Elle inverse le bronchospasme et la vasodilation."}},
    {en:"What is a drug's half-life?",fr:"Qu'est-ce que la demi-vie d'un m√©dicament ?",a:{en:["Time to reduce concentration by 50%","Time to reach peak effect","Time to fully eliminate","Time to start working"],fr:["Temps pour r√©duire la concentration de 50%","Temps pour l'effet maximal","Temps d'√©limination total","Temps avant effet"]},ca:0,exp:{en:"Half-life is the time for plasma drug concentration to decrease by 50%. It determines dosing intervals.",fr:"La demi-vie est le temps pour que la concentration plasmatique diminue de 50%."}},
    {en:"What is the first-line oral drug for Type 2 diabetes?",fr:"Quel m√©dicament oral de premi√®re intention pour le diab√®te type 2 ?",a:{en:["Metformin","Insulin","Glipizide","Acarbose"],fr:["Metformine","Insuline","Glipizide","Acarbose"]},ca:0,exp:{en:"Metformin reduces hepatic glucose production and improves insulin sensitivity with minimal hypoglycemia risk.",fr:"La metformine r√©duit la production h√©patique de glucose et am√©liore la sensibilit√© √† l'insuline."}},
    {en:"Which antibiotic class inhibits bacterial cell wall synthesis?",fr:"Quelle classe d'antibiotiques inhibe la synth√®se de la paroi bact√©rienne ?",a:{en:["Penicillins","Tetracyclines","Macrolides","Fluoroquinolones"],fr:["P√©nicillines","T√©tracyclines","Macrolides","Fluoroquinolones"]},ca:0,exp:{en:"Penicillins inhibit peptidoglycan cross-linking in bacterial cell walls, causing cell lysis.",fr:"Les p√©nicillines inhibent la r√©ticulation du peptidoglycane, causant la lyse bact√©rienne."}},
    {en:"What is bioavailability?",fr:"Qu'est-ce que la biodisponibilit√© ?",a:{en:["Fraction reaching systemic circulation","Drug potency","Drug efficacy","Drug toxicity"],fr:["Fraction atteignant la circulation","Puissance du m√©dicament","Efficacit√©","Toxicit√©"]},ca:0,exp:{en:"Bioavailability is the fraction of drug that reaches systemic circulation unchanged. IV = 100%.",fr:"La biodisponibilit√© est la fraction du m√©dicament atteignant la circulation. IV = 100%."}},
    {en:"What is the mechanism of statins?",fr:"Quel est le m√©canisme des statines ?",a:{en:["HMG-CoA reductase inhibition","ACE inhibition","Beta blockade","Calcium channel blockade"],fr:["Inhibition HMG-CoA r√©ductase","Inhibition ACE","B√™ta-blocage","Blocage calcique"]},ca:0,exp:{en:"Statins inhibit HMG-CoA reductase, the rate-limiting enzyme of cholesterol synthesis in the liver.",fr:"Les statines inhibent la HMG-CoA r√©ductase, enzyme cl√© de la synth√®se du cholest√©rol."}},
    {en:"Which drug treats Parkinson's disease?",fr:"Quel m√©dicament traite la maladie de Parkinson ?",a:{en:["Levodopa","Insulin","Warfarin","Aspirin"],fr:["L√©vodopa","Insuline","Warfarine","Aspirine"]},ca:0,exp:{en:"Levodopa crosses the blood-brain barrier and converts to dopamine, replacing the deficient neurotransmitter.",fr:"La l√©vodopa traverse la barri√®re h√©mato-enc√©phalique et se convertit en dopamine."}},
    {en:"Which drug is a loop diuretic?",fr:"Quel m√©dicament est un diur√©tique de l'anse ?",a:{en:["Furosemide","Atenolol","Lisinopril","Amlodipine"],fr:["Furos√©mide","At√©nolol","Lisinopril","Amlodipine"]},ca:0,exp:{en:"Furosemide blocks the Na-K-2Cl cotransporter in the loop of Henle, causing potent diuresis.",fr:"Le furos√©mide bloque le cotransporteur Na-K-2Cl dans l'anse de Henle."}},
    {en:"What opioid receptor does morphine act on?",fr:"Sur quel r√©cepteur opio√Øde la morphine agit-elle ?",a:{en:["Mu (Œº) receptor","Kappa (Œ∫) receptor","Delta (Œ¥) receptor","Sigma (œÉ) receptor"],fr:["R√©cepteur mu (Œº)","R√©cepteur kappa (Œ∫)","R√©cepteur delta (Œ¥)","R√©cepteur sigma (œÉ)"]},ca:0,exp:{en:"Morphine is primarily a mu-opioid agonist, causing analgesia, euphoria, and respiratory depression.",fr:"La morphine est principalement un agoniste mu-opio√Øde : analg√©sie et d√©pression respiratoire."}},
    {en:"What is a prodrug?",fr:"Qu'est-ce qu'une prodrogue ?",a:{en:["Inactive form converted to active drug","Active drug form","Drug metabolite","Drug antagonist"],fr:["Forme inactive convertie en active","Forme active du m√©dicament","M√©tabolite","Antagoniste"]},ca:0,exp:{en:"Prodrugs are inactive until metabolized (e.g., codeine ‚Üí morphine, enalapril ‚Üí enalaprilat).",fr:"Les prodrogues sont inactives jusqu'√† leur m√©tabolisation (ex: cod√©ine ‚Üí morphine)."}},
    {en:"What does the therapeutic index measure?",fr:"Que mesure l'indice th√©rapeutique ?",a:{en:["Ratio of toxic to therapeutic dose","Drug absorption rate","Drug elimination rate","Drug half-life"],fr:["Ratio dose toxique/th√©rapeutique","Taux d'absorption","Taux d'√©limination","Demi-vie"]},ca:0,exp:{en:"Therapeutic Index = TD50 / ED50. A narrow TI means small dose errors can be dangerous (e.g., lithium, digoxin).",fr:"Index th√©rapeutique = DT50/DE50. Un IT √©troit signifie que les erreurs de dosage sont dangereuses."}},
    {en:"What treats acute asthma attack?",fr:"Quel m√©dicament traite une crise d'asthme aigu√´ ?",a:{en:["Albuterol (salbutamol)","Digoxin","Warfarin","Metformin"],fr:["Albut√©rol (salbutamol)","Digoxine","Warfarine","Metformine"]},ca:0,exp:{en:"Albuterol is a short-acting beta-2 agonist (SABA) that rapidly bronchodilates the airways.",fr:"L'albut√©rol est un agoniste b√™ta-2 √† action rapide qui dilate rapidement les bronches."}},
    {en:"What is first-pass metabolism?",fr:"Qu'est-ce que le m√©tabolisme de premier passage ?",a:{en:["Drug metabolism in liver before systemic circulation","Absorption in the stomach","Elimination by kidneys","Distribution to tissues"],fr:["M√©tabolisme h√©patique avant la circulation","Absorption gastrique","√âlimination r√©nale","Distribution tissulaire"]},ca:0,exp:{en:"First-pass metabolism occurs in the liver before drugs reach systemic circulation, reducing oral bioavailability.",fr:"Le premier passage h√©patique r√©duit la biodisponibilit√© des m√©dicaments oraux."}}
  ]
},
year5:{
  label:{en:"YEAR 5 ‚Äî INTERNAL MEDICINE",fr:"ANN√âE 5 ‚Äî M√âDECINE INTERNE"},
  qs:[
    {en:"What is the most common cause of heart failure?",fr:"Quelle est la cause la plus fr√©quente d'insuffisance cardiaque ?",a:{en:["Coronary artery disease","Valvular disease","Cardiomyopathy","Arrhythmia"],fr:["Maladie coronarienne","Maladie valvulaire","Cardiomyopathie","Arythmie"]},ca:0,exp:{en:"CAD reduces blood supply to heart muscle causing ischemia and eventual pump failure.",fr:"La maladie coronarienne r√©duit l'apport sanguin au myocarde, causant une d√©faillance pompe."}},
    {en:"Which test is used to diagnose and monitor diabetes?",fr:"Quel test diagnostique et surveille le diab√®te ?",a:{en:["HbA1c","CBC","Lipid panel","Liver function tests"],fr:["HbA1c","NFS","Bilan lipidique","Tests h√©patiques"]},ca:0,exp:{en:"HbA1c ‚â•6.5% diagnoses diabetes. It reflects average blood glucose over the past 2-3 months.",fr:"Une HbA1c ‚â•6,5% diagnostique le diab√®te et refl√®te la glyc√©mie des 2-3 derniers mois."}},
    {en:"What treats hypothyroidism?",fr:"Quel est le traitement de l'hypothyro√Ødie ?",a:{en:["Levothyroxine","Methimazole","Radioactive iodine","Beta blockers"],fr:["L√©vothyroxine","M√©thimazole","Iode radioactif","B√™ta-bloquants"]},ca:0,exp:{en:"Levothyroxine is synthetic T4 that replaces the deficient thyroid hormone in hypothyroidism.",fr:"La l√©vothyroxine est la T4 synth√©tique qui remplace l'hormone thyro√Ødienne d√©ficiente."}},
    {en:"What is the hallmark of nephrotic syndrome?",fr:"Quelle est la caract√©ristique principale du syndrome n√©phrotique ?",a:{en:["Heavy proteinuria (>3.5g/day)","Hematuria","Oliguria","Polyuria"],fr:["Prot√©inurie massive (>3,5g/j)","H√©maturie","Oligurie","Polyurie"]},ca:0,exp:{en:"Proteinuria >3.5g/day with hypoalbuminemia, edema, and hyperlipidemia defines nephrotic syndrome.",fr:"Prot√©inurie >3,5g/j avec hypoalbumin√©mie, ≈ìd√®mes et hyperlipid√©mie d√©finissent le syndrome."}},
    {en:"What elevates troponin?",fr:"Quelle condition √©l√®ve la troponine ?",a:{en:["Myocardial infarction","Stroke","Pneumonia","Renal failure"],fr:["Infarctus du myocarde","AVC","Pneumonie","Insuffisance r√©nale"]},ca:0,exp:{en:"Cardiac troponin (cTnI, cTnT) is highly specific for myocardial damage and rises within 3-6 hours of MI.",fr:"La troponine cardiaque est tr√®s sp√©cifique des dommages myocardiques, √©lev√©e 3-6h apr√®s l'IDM."}},
    {en:"Which disease causes autoimmune demyelination in the CNS?",fr:"Quelle maladie cause une d√©my√©linisation auto-immune du SNC ?",a:{en:["Multiple sclerosis","Parkinson's disease","Alzheimer's disease","ALS"],fr:["Scl√©rose en plaques","Maladie de Parkinson","Alzheimer","SLA"]},ca:0,exp:{en:"MS is an autoimmune disease where T-cells attack myelin sheaths, causing plaques throughout the CNS.",fr:"La SEP est une maladie auto-immune o√π les lymphocytes T attaquent les gaines de my√©line."}},
    {en:"What is the most common type of anemia worldwide?",fr:"Quel est le type d'an√©mie le plus courant dans le monde ?",a:{en:["Iron deficiency anemia","B12 deficiency anemia","Folate deficiency anemia","Hemolytic anemia"],fr:["An√©mie ferriprive","An√©mie par carence en B12","An√©mie par carence en folates","An√©mie h√©molytique"]},ca:0,exp:{en:"Iron deficiency anemia is the most common anemia globally, causing microcytic, hypochromic RBCs.",fr:"L'an√©mie ferriprive est la plus courante dans le monde, causant des GR microcytaires."}},
    {en:"What is Crohn's disease characterized by?",fr:"Quelle est la caract√©ristique de la maladie de Crohn ?",a:{en:["Transmural inflammation of any GI segment","Mucosal inflammation of colon only","Vascular inflammation","Nerve inflammation"],fr:["Inflammation transmurale de tout le TD","Inflammation muqueuse du c√¥lon","Inflammation vasculaire","Inflammation nerveuse"]},ca:0,exp:{en:"Crohn's affects all GI layers (transmural) and can occur anywhere from mouth to anus, unlike UC.",fr:"Crohn affecte toutes les couches du TD et peut toucher de la bouche √† l'anus."}},
    {en:"What causes jaundice?",fr:"Quelle condition cause la jaunisse ?",a:{en:["Elevated bilirubin from liver disease","Heart disease","Kidney disease","Lung disease"],fr:["Bilirubine √©lev√©e (maladie h√©patique)","Maladie cardiaque","Maladie r√©nale","Maladie pulmonaire"]},ca:0,exp:{en:"Jaundice results from elevated bilirubin (>2-3 mg/dL) causing yellow skin/sclera. Causes: pre/intra/post-hepatic.",fr:"La jaunisse r√©sulte d'une hyperbilirubin√©mie (>2-3 mg/dL) causant un teint jaune."}},
    {en:"What treats GERD most effectively?",fr:"Quel m√©dicament traite le plus efficacement le RGO ?",a:{en:["Proton pump inhibitors (PPIs)","Antacids alone","H2 blockers","Antibiotics"],fr:["Inhibiteurs de la pompe √† protons (IPP)","Antiacides seuls","Anti-H2","Antibiotiques"]},ca:0,exp:{en:"PPIs (omeprazole, pantoprazole) irreversibly block the H+/K+ ATPase pump and are most effective for GERD.",fr:"Les IPP bloquent irr√©versiblement la pompe H+/K+ ATPase et sont les plus efficaces."}},
    {en:"What is the most common autoimmune disease?",fr:"Quelle est la maladie auto-immune la plus courante ?",a:{en:["Lupus (SLE)","Rheumatoid arthritis","Type 1 diabetes","Crohn's disease"],fr:["Lupus (LES)","Polyarthrite rhumato√Øde","Diab√®te type 1","Maladie de Crohn"]},ca:0,exp:{en:"SLE (Systemic Lupus Erythematosus) is characterized by butterfly rash and multi-organ involvement.",fr:"Le LES est caract√©ris√© par un rash en papillon et une atteinte multi-organes."}},
    {en:"How is atrial fibrillation best treated?",fr:"Comment traiter au mieux la fibrillation auriculaire ?",a:{en:["Rate control + anticoagulation","Antibiotics only","Diuretics only","Beta blockers alone"],fr:["Contr√¥le rythme + anticoagulation","Antibiotiques seulement","Diur√©tiques seulement","B√™ta-bloquants seuls"]},ca:0,exp:{en:"AF management includes rate/rhythm control to prevent HF, and anticoagulation to prevent stroke.",fr:"La FA n√©cessite contr√¥le du rythme et anticoagulation pour pr√©venir l'AVC."}},
    {en:"What diagnoses myocardial infarction?",fr:"Quel examen diagnostique l'infarctus du myocarde ?",a:{en:["ECG + cardiac troponin","CBC + CRP","Chest X-ray","Brain MRI"],fr:["ECG + troponine cardiaque","NFS + CRP","Radio thorax","IRM c√©r√©brale"]},ca:0,exp:{en:"ECG shows ST elevation/depression; troponin confirms myocardial necrosis. Both needed for diagnosis.",fr:"L'ECG montre les modifications ST ; la troponine confirme la n√©crose myocardique."}},
    {en:"What is the first-line for hypertension in most patients?",fr:"Traitement de premi√®re intention de l'hypertension chez la plupart des patients ?",a:{en:["Thiazide diuretics","Beta blockers","ACE inhibitors","Calcium channel blockers"],fr:["Diur√©tiques thiazidiques","B√™ta-bloquants","Inhibiteurs ACE","Bloqueurs calciques"]},ca:0,exp:{en:"Thiazides (hydrochlorothiazide) are often first-line for uncomplicated hypertension in most guidelines.",fr:"Les thiazidiques sont souvent de premi√®re intention pour l'hypertension non compliqu√©e."}},
    {en:"What treats acute COPD exacerbation?",fr:"Quel est le traitement de l'exacerbation aigu√´ de la BPCO ?",a:{en:["Bronchodilators + systemic steroids","Antibiotics alone","Surgery","Oxygen alone"],fr:["Bronchodilatateurs + st√©ro√Ødes","Antibiotiques seuls","Chirurgie","Oxyg√®ne seul"]},ca:0,exp:{en:"COPD exacerbation treatment: short-acting bronchodilators, systemic corticosteroids (5 days), antibiotics if needed.",fr:"Traitement : bronchodilatateurs, corticost√©ro√Ødes syst√©miques (5j), antibiotiques si besoin."}}
  ]
},
year6:{
  label:{en:"YEAR 6 ‚Äî SURGERY & SPECIALTIES",fr:"ANN√âE 6 ‚Äî CHIRURGIE & SP√âCIALIT√âS"},
  qs:[
    {en:"What is the most common surgical emergency?",fr:"Quelle est l'urgence chirurgicale la plus courante ?",a:{en:["Appendicitis","Cholecystitis","Bowel obstruction","Perforated ulcer"],fr:["Appendicite","Chol√©cystite","Occlusion intestinale","Ulc√®re perfor√©"]},ca:0,exp:{en:"Appendicitis affects ~7% of the population and is the most common surgical emergency requiring immediate appendectomy.",fr:"L'appendicite touche ~7% de la population et est l'urgence chirurgicale la plus courante."}},
    {en:"Which suture material is absorbable?",fr:"Quel mat√©riau de suture est absorbable ?",a:{en:["Vicryl (polyglactin)","Silk","Nylon","Prolene"],fr:["Vicryl (polyglactine)","Soie","Nylon","Prol√®ne"]},ca:0,exp:{en:"Vicryl (polyglactin 910) degrades by hydrolysis in 60-90 days. Used for internal tissues that don't need permanent support.",fr:"Le Vicryl se d√©grade par hydrolyse en 60-90 jours. Utilis√© pour les tissus internes."}},
    {en:"Definitive treatment for acute cholecystitis?",fr:"Traitement d√©finitif de la chol√©cystite aigu√´ ?",a:{en:["Laparoscopic cholecystectomy","Antibiotics only","IV fluids only","Drainage only"],fr:["Chol√©cystectomie laparoscopique","Antibiotiques seulement","Liquides IV seulement","Drainage seulement"]},ca:0,exp:{en:"Laparoscopic cholecystectomy within 72 hours is the gold standard for acute cholecystitis.",fr:"La chol√©cystectomie laparoscopique dans les 72h est l'√©talon-or de la chol√©cystite aigu√´."}},
    {en:"Gold standard imaging for suspected appendicitis?",fr:"Imagerie de r√©f√©rence pour l'appendicite suspect√©e ?",a:{en:["CT scan with contrast","Plain X-ray","Ultrasound","MRI"],fr:["Scanner avec contraste","Radiographie simple","√âchographie","IRM"]},ca:0,exp:{en:"CT scan has ~95% sensitivity and specificity for appendicitis. Ultrasound used first in children/pregnancy.",fr:"Le scanner a ~95% de sensibilit√© et sp√©cificit√©. L'√©chographie est utilis√©e en p√©diatrie/grossesse."}},
    {en:"Complication of parathyroid damage during thyroid surgery?",fr:"Complication des dommages parathyro√Ødiens lors d'une thyro√Ødectomie ?",a:{en:["Hypocalcemia","Hypercalcemia","Hyperglycemia","Hypokalemia"],fr:["Hypocalc√©mie","Hypercalc√©mie","Hyperglyc√©mie","Hypokali√©mie"]},ca:0,exp:{en:"Accidental parathyroid removal reduces PTH, causing hypocalcemia (tetany, Chvostek's sign).",fr:"L'ablation accidentelle des parathyro√Ødes r√©duit la PTH et cause l'hypocalc√©mie."}},
    {en:"Most commonly transplanted organ?",fr:"Quel organe est le plus souvent transplant√© ?",a:{en:["Kidney","Heart","Liver","Lung"],fr:["Rein","C≈ìur","Foie","Poumon"]},ca:0,exp:{en:"Kidney transplants account for ~60% of all solid organ transplants due to dialysis availability as bridge.",fr:"Les greffes de rein repr√©sentent ~60% des transplantations d'organes solides."}},
    {en:"Immediate treatment for tension pneumothorax?",fr:"Traitement imm√©diat du pneumothorax sous tension ?",a:{en:["Needle decompression (2nd ICS, MCL)","IV antibiotics","Observation","Chest physiotherapy"],fr:["D√©compression √† l'aiguille (2e EIC, LMC)","Antibiotiques IV","Observation","Kin√©sith√©rapie"]},ca:0,exp:{en:"Needle decompression in 2nd intercostal space, midclavicular line, followed by chest tube insertion.",fr:"D√©compression √† l'aiguille au 2e espace intercostal, ligne m√©dio-claviculaire, puis drainage."}},
    {en:"What surgery treats breast cancer?",fr:"Quelle chirurgie traite le cancer du sein ?",a:{en:["Mastectomy or lumpectomy (depending on stage)","Appendectomy","Cholecystectomy","Hysterectomy"],fr:["Mastectomie ou tumorectomie (selon le stade)","Appendicectomie","Chol√©cystectomie","Hyst√©rectomie"]},ca:0,exp:{en:"Stage I-II: lumpectomy + radiation. Stage III-IV or BRCA+: mastectomy. Depends on tumor size and margins.",fr:"Stade I-II: tumorectomie + RT. Stade III-IV ou BRCA+: mastectomie."}},
    {en:"Complication of splenectomy?",fr:"Complication principale de la spl√©nectomie ?",a:{en:["Increased risk of encapsulated bacterial infections","Excessive bleeding","Liver failure","Kidney failure"],fr:["Risque accru d'infections bact√©riennes encapsul√©es","Saignement excessif","Insuffisance h√©patique","Insuffisance r√©nale"]},ca:0,exp:{en:"Splenectomy increases risk of OPSI (overwhelming post-splenectomy infection) from encapsulated bacteria (Strep, H. flu, Neisseria).",fr:"La spl√©nectomie augmente le risque d'infections par bact√©ries encapsul√©es (OPSI)."}},
    {en:"Non-invasive treatment for kidney stones?",fr:"Traitement non invasif des calculs r√©naux ?",a:{en:["ESWL (Extracorporeal Shock Wave Lithotripsy)","Nephrectomy","Dialysis","Transplant"],fr:["LEC (Lithotritie extracorporelle)","N√©phrectomie","Dialyse","Transplantation"]},ca:0,exp:{en:"ESWL uses ultrasonic shock waves to fragment stones <2cm into passable pieces.",fr:"La LEC utilise des ondes de choc pour fragmenter les calculs < 2 cm."}},
    {en:"Primary anesthetic for C-section?",fr:"Anesth√©sie de choix pour la c√©sarienne ?",a:{en:["Spinal or epidural anesthesia","General anesthesia","Local anesthesia only","No anesthesia"],fr:["Rachianesth√©sie ou p√©ridurale","Anesth√©sie g√©n√©rale","Anesth√©sie locale seulement","Aucune anesth√©sie"]},ca:0,exp:{en:"Regional anesthesia (spinal/epidural) allows the mother to stay awake and avoids neonatal sedation.",fr:"L'anesth√©sie r√©gionale permet √† la m√®re d'√™tre √©veill√©e et √©vite la s√©dation n√©onatale."}},
    {en:"What surgery treats coronary artery disease?",fr:"Quelle chirurgie traite la maladie coronarienne ?",a:{en:["CABG (Coronary Artery Bypass Grafting)","Appendectomy","Herniorrhaphy","Colectomy"],fr:["PAC (Pontage aorto-coronarien)","Appendicectomie","Herniorraphie","Colectomie"]},ca:0,exp:{en:"CABG uses grafts from the saphenous vein or internal mammary artery to bypass blocked coronary arteries.",fr:"Le PAC utilise des greffons pour contourner les art√®res coronaires obstru√©es."}},
    {en:"What treats varicose veins non-surgically?",fr:"Quel est le traitement non chirurgical des varices ?",a:{en:["Sclerotherapy","Anticoagulants","Thrombolytics","Antibiotics"],fr:["Scl√©roth√©rapie","Anticoagulants","Thrombolytiques","Antibiotiques"]},ca:0,exp:{en:"Sclerotherapy injects a solution (sclerosant) that irritates and closes the vein.",fr:"La scl√©roth√©rapie injecte un agent scl√©rosant qui ferme la veine."}},
    {en:"Surgical treatment for carpal tunnel syndrome?",fr:"Traitement chirurgical du syndrome du canal carpien ?",a:{en:["Carpal tunnel release (cut transverse ligament)","Amputation","Arthrodesis","Joint replacement"],fr:["Lib√©ration du canal carpien (section du ligament)","Amputation","Arthrod√®se","Remplacement articulaire"]},ca:0,exp:{en:"Cutting the transverse carpal ligament decompresses the median nerve and provides permanent relief.",fr:"La section du ligament carpien transverse d√©comprime le nerf m√©dian et donne un soulagement durable."}},
    {en:"Which fracture is most common in elderly patients?",fr:"Quelle fracture est la plus courante chez les personnes √¢g√©es ?",a:{en:["Hip fracture (proximal femur)","Skull fracture","Rib fracture","Clavicle fracture"],fr:["Fracture de hanche (f√©mur proximal)","Fracture du cr√¢ne","Fracture de c√¥te","Fracture de la clavicule"]},ca:0,exp:{en:"Hip fractures (proximal femur) are common in elderly due to osteoporosis and falls. High mortality if untreated.",fr:"Les fractures de hanche sont fr√©quentes chez les personnes √¢g√©es ost√©oporotiques."}}
  ]
},
year7:{
  label:{en:"YEAR 7 ‚Äî CLINICAL MEDICINE & EMERGENCY",fr:"ANN√âE 7 ‚Äî M√âDECINE CLINIQUE & URGENCES"},
  qs:[
    {en:"What is the first step in ACLS (cardiac arrest)?",fr:"Quelle est la premi√®re √©tape de l'ACLS (arr√™t cardiaque) ?",a:{en:["Check responsiveness & call for help","Start CPR immediately","Defibrillate","Give epinephrine"],fr:["V√©rifier la r√©activit√© & appeler de l'aide","Commencer la RCP imm√©diatement","D√©fibriller","Donner de l'√©pin√©phrine"]},ca:0,exp:{en:"Always confirm unresponsiveness, call for help/AED, then start CPR. Defibrillation follows rhythm assessment.",fr:"Toujours confirmer l'inconscience, appeler √† l'aide, puis commencer la RCP."}},
    {en:"First-line treatment for anaphylactic shock?",fr:"Traitement de premi√®re intention du choc anaphylactique ?",a:{en:["Epinephrine IM (thigh)","Oral antihistamines","IV corticosteroids only","Observation"],fr:["√âpin√©phrine IM (cuisse)","Antihistaminiques oraux","Corticost√©ro√Ødes IV seuls","Observation"]},ca:0,exp:{en:"IM epinephrine (0.3-0.5mg auto-injector) in the outer thigh is first-line. Delays worsen outcomes.",fr:"L'√©pin√©phrine IM (0,3-0,5 mg) dans la cuisse est de premi√®re intention. Les d√©lais aggravent le pronostic."}},
    {en:"Which score quantifies stroke severity?",fr:"Quel score quantifie la gravit√© de l'AVC ?",a:{en:["NIHSS (NIH Stroke Scale)","Glasgow Coma Scale","APACHE II","SOFA Score"],fr:["NIHSS (√âchelle NIH)","√âchelle de Glasgow","APACHE II","Score SOFA"]},ca:0,exp:{en:"NIHSS (0-42) assesses 11 neurological domains. Score >15 = severe stroke. Used for tPA eligibility.",fr:"Le NIHSS (0-42) √©value 11 domaines neurologiques. Score >15 = AVC s√©v√®re."}},
    {en:"What reverses opioid overdose?",fr:"Quel m√©dicament inverse le surdosage d'opio√Ødes ?",a:{en:["Naloxone","Flumazenil","Atropine","Epinephrine"],fr:["Naloxone","Flumaz√©nil","Atropine","√âpin√©phrine"]},ca:0,exp:{en:"Naloxone is a competitive opioid antagonist that rapidly reverses respiratory depression (onset 2-5 min).",fr:"La naloxone est un antagoniste opio√Øde comp√©titif qui inverse rapidement la d√©pression respiratoire."}},
    {en:"What causes Kussmaul breathing?",fr:"Quelle condition cause la respiration de Kussmaul ?",a:{en:["Diabetic ketoacidosis (DKA)","Asthma","COPD","Pulmonary embolism"],fr:["Acidoc√©tose diab√©tique (ACD)","Asthme","BPCO","Embolie pulmonaire"]},ca:0,exp:{en:"Kussmaul breathing is deep, labored breathing that compensates for metabolic acidosis in DKA.",fr:"La respiration de Kussmaul est une respiration profonde compensant l'acidose m√©tabolique de l'ACD."}},
    {en:"First-line drugs to stop active seizures?",fr:"M√©dicaments de premi√®re intention pour arr√™ter les convulsions actives ?",a:{en:["Benzodiazepines (lorazepam/diazepam)","Antibiotics","Antivirals","Phenytoin alone"],fr:["Benzodiaz√©pines (loraz√©pam/diaz√©pam)","Antibiotiques","Antiviraux","Ph√©nyto√Øne seule"]},ca:0,exp:{en:"IV lorazepam or IM midazolam are first-line. Enhance GABA inhibition to terminate seizure activity.",fr:"Le loraz√©pam IV ou le midazolam IM sont de premi√®re intention : potentialisent l'inhibition GABA."}},
    {en:"Gold standard test for pulmonary embolism?",fr:"Test de r√©f√©rence pour le diagnostic de l'embolie pulmonaire ?",a:{en:["CT Pulmonary Angiography (CTPA)","Plain chest X-ray","ECG alone","CBC"],fr:["Angioscanner pulmonaire (CTEP)","Radio thorax simple","ECG seul","NFS"]},ca:0,exp:{en:"CTPA visualizes clots in pulmonary arteries with high sensitivity/specificity (~95%/98%).",fr:"Le CTEP visualise les caillots dans les art√®res pulmonaires avec haute sensibilit√©/sp√©cificit√©."}},
    {en:"Treatment for symptomatic hypoglycemia?",fr:"Traitement de l'hypoglyc√©mie symptomatique ?",a:{en:["15-20g oral glucose or IV dextrose (if unconscious)","Insulin","Metformin","Nothing - wait"],fr:["15-20g glucose oral ou dextrose IV (si inconscient)","Insuline","Metformine","Attendre"]},ca:0,exp:{en:"Conscious: 15-20g fast carbs (glucose tablets, juice). Unconscious: IV dextrose 50% or IM glucagon.",fr:"Conscient : 15-20g de sucres rapides. Inconscient : dextrose 50% IV ou glucagon IM."}},
    {en:"What is the full Glasgow Coma Scale range?",fr:"Quelle est la plage compl√®te de l'√©chelle de Glasgow (GCS) ?",a:{en:["3-15","1-10","0-20","5-25"],fr:["3-15","1-10","0-20","5-25"]},ca:0,exp:{en:"GCS: Eyes (1-4) + Verbal (1-5) + Motor (1-6) = 3-15. GCS ‚â§8 = severe brain injury, consider intubation.",fr:"GCS: Yeux (1-4) + Verbal (1-5) + Moteur (1-6) = 3-15. GCS ‚â§8 = l√©sion c√©r√©brale grave."}},
    {en:"Which drug is given during cardiac arrest?",fr:"Quel m√©dicament est donn√© pendant l'arr√™t cardiaque ?",a:{en:["Epinephrine (every 3-5 min)","Insulin","Metformin","Aspirin alone"],fr:["√âpin√©phrine (toutes les 3-5 min)","Insuline","Metformine","Aspirine seule"]},ca:0,exp:{en:"Epinephrine 1mg IV/IO every 3-5 min increases coronary and cerebral perfusion pressure during CPR.",fr:"√âpin√©phrine 1mg IV toutes les 3-5 min augmente la pression de perfusion coronarienne."}},
    {en:"What sign indicates basilar skull fracture?",fr:"Quel signe indique une fracture de la base du cr√¢ne ?",a:{en:["Battle's sign (bruising behind ear)","Cullen's sign","Grey Turner's sign","Kernig's sign"],fr:["Signe de Battle (ecchymose r√©tro-auriculaire)","Signe de Cullen","Signe de Grey Turner","Signe de Kernig"]},ca:0,exp:{en:"Battle's sign: ecchymosis over the mastoid process. Also: raccoon eyes, CSF rhinorrhea/otorrhea.",fr:"Signe de Battle : ecchymose masto√Ødienne. Aussi : yeux de raton laveur, √©coulement LCR."}},
    {en:"Emergency treatment for hyperkalemia?",fr:"Traitement d'urgence de l'hyperkali√©mie ?",a:{en:["IV calcium gluconate + insulin + dextrose","Potassium supplements","Sodium supplements","Magnesium infusion"],fr:["Gluconate de calcium IV + insuline + dextrose","Suppl√©ments de potassium","Suppl√©ments de sodium","Perfusion de magn√©sium"]},ca:0,exp:{en:"Calcium gluconate stabilizes cardiac membrane. Insulin+dextrose shifts K+ into cells. Kayexalate/dialysis for removal.",fr:"Le calcium gluconate stabilise le myocarde. L'insuline+dextrose fait rentrer K+ dans les cellules."}},
    {en:"What reverses benzodiazepine overdose?",fr:"Quel m√©dicament inverse le surdosage aux benzodiaz√©pines ?",a:{en:["Flumazenil","Naloxone","Atropine","Physostigmine"],fr:["Flumaz√©nil","Naloxone","Atropine","Physostigmine"]},ca:0,exp:{en:"Flumazenil competitively antagonizes GABA-A benzodiazepine receptors. Short-acting - may need repeated doses.",fr:"Le flumaz√©nil antagonise les r√©cepteurs GABA-A. Courte dur√©e : peut n√©cessiter des redoses."}},
    {en:"What causes cherry-red skin in poisoning?",fr:"Quelle intoxication cause une peau rouge cerise ?",a:{en:["Carbon monoxide (CO) poisoning","Cyanide poisoning","Methanol poisoning","Ethylene glycol poisoning"],fr:["Intoxication au monoxyde de carbone","Intoxication au cyanure","Intoxication au m√©thanol","Intoxication √† l'√©thyl√®ne glycol"]},ca:0,exp:{en:"CO binds hemoglobin forming carboxyhemoglobin (cherry-red). Causes tissue hypoxia. Treat with 100% O2.",fr:"Le CO forme la carboxyh√©moglobine (rouge cerise). Hypoxie tissulaire. Traiter √† 100% O2."}},
    {en:"First step in trauma primary survey?",fr:"Premi√®re √©tape du bilan traumatologique primaire ?",a:{en:["Airway assessment and protection","CT scan","Complete blood count","IV access"],fr:["√âvaluation et protection des voies a√©riennes","Scanner","Num√©ration formule sanguine","Voie veineuse"]},ca:0,exp:{en:"ABCDE survey: Airway ‚Üí Breathing ‚Üí Circulation ‚Üí Disability ‚Üí Exposure. Airway always first.",fr:"Bilan ABCDE: Voies a√©riennes ‚Üí Respiration ‚Üí Circulation ‚Üí D√©ficit neuro ‚Üí Exposition."}}
  ]
}
};

// ============================================================
// TRANSLATIONS
// ============================================================
const T = {
en:{
year:"YEAR",level:"LEVEL",score:"SCORE",paused:"PAUSED",resume:"RESUME",
restart:"RESTART LEVEL",quit:"QUIT TO MENU",skip:"SKIP (10s)",yearComplete:"YEAR COMPLETE!",
nextYear:"CONTINUE",
certTitle:"IS OFFICIALLY A DOCTOR OF MEDICINE",
certSchool:"DOCTOR QUEST MEDICAL SCHOOL",
certPresents:"THIS CERTIFIES THAT",
certBody:"Having successfully completed seven years of rigorous medical education with distinction.",
sigDean:"DEAN OF MEDICINE",sigReg:"MEDICAL REGISTRAR",
saveCert:"SAVE CERTIFICATE",playAgain:"PLAY AGAIN",
graduates:"GRADUATES",
howToPlay:"üì± USE THE D-PAD (arrows) to move\n\nüéØ Answer 3 medical questions per level\n\nüîì Answer all 3 to unlock the green exit ‚ñ∂\n\n‚ö° Build answer streaks for bonus points!\n\nüíæ Progress auto-saves every 3 correct answers\n\n‚å®Ô∏è Keyboard: WASD or Arrow Keys also work!",
langBtn:"üåê LANGUAGE: ENGLISH",startBtn:"üéì BEGIN MEDICAL SCHOOL",continueBtn:"üìÇ CONTINUE PROGRESS",howBtn:"‚ùì HOW TO PLAY",
correct:"‚úì CORRECT!",wrong:"‚úó INCORRECT",
narrator1:"Find the green exit ‚ñ∂ to advance!",
narrator2:"Answer questions to unlock the exit!",
narrator3:"Year ",narrator4:" ‚Äî Level ",
exitLocked:"Answer all 3 questions to unlock the exit!",
exitOpen:"EXIT UNLOCKED ‚Äî Reach the green square ‚ñ∂!",
yearComp1:"You have completed Year ",yearComp2:" of Medical School!",
questionTitle:"MEDICAL QUESTION",
encouraging:["EXCELLENT! üåü","PERFECT! üéØ","BRILLIANT! üí°","OUTSTANDING! üèÜ","AMAZING! ‚≠ê","GREAT JOB! üëè","WELL DONE! üéâ","FANTASTIC! üöÄ","SUPERB! üí™","NAILED IT! ‚úÖ"],
saveLoaded:"Welcome back, Dr. ",
enterName:"Enter your name to start"
},
fr:{
year:"ANN√âE",level:"NIVEAU",score:"SCORE",paused:"PAUSE",resume:"REPRENDRE",
restart:"RECOMMENCER",quit:"QUITTER",skip:"PASSER (10s)",yearComplete:"ANN√âE TERMIN√âE !",
nextYear:"CONTINUER",
certTitle:"EST OFFICIELLEMENT DOCTEUR EN M√âDECINE",
certSchool:"√âCOLE DE M√âDECINE DOCTOR QUEST",
certPresents:"LE PR√âSENT CERTIFICAT ATTESTE QUE",
certBody:"Ayant r√©ussi avec distinction sept ann√©es d'enseignement m√©dical rigoureux.",
sigDean:"DOYEN DE M√âDECINE",sigReg:"REGISTRAIRE M√âDICAL",
saveCert:"ENREGISTRER",playAgain:"REJOUER",
graduates:"DIPL√îM√âS",
howToPlay:"üì± UTILISEZ LE D-PAD (fl√®ches) pour vous d√©placer\n\nüéØ R√©pondez √† 3 questions par niveau\n\nüîì R√©pondez aux 3 pour d√©bloquer la sortie verte ‚ñ∂\n\n‚ö° Accumulez des s√©ries pour des points bonus !\n\nüíæ La progression sauvegarde automatiquement\n\n‚å®Ô∏è Clavier : WASD ou touches fl√©ch√©es",
langBtn:"üåê LANGUE : FRAN√áAIS",startBtn:"üéì COMMENCER L'√âCOLE",continueBtn:"üìÇ CONTINUER",howBtn:"‚ùì COMMENT JOUER",
correct:"‚úì CORRECT !",wrong:"‚úó INCORRECT",
narrator1:"Trouvez la sortie verte ‚ñ∂ pour avancer !",
narrator2:"R√©pondez aux questions pour d√©bloquer la sortie !",
narrator3:"Ann√©e ",narrator4:" ‚Äî Niveau ",
exitLocked:"R√©pondez aux 3 questions pour d√©bloquer la sortie !",
exitOpen:"SORTIE D√âVERROUILL√âE ‚Äî Atteignez le carr√© vert ‚ñ∂ !",
yearComp1:"Vous avez termin√© l'Ann√©e ",yearComp2:" de l'√âcole de M√©decine !",
questionTitle:"QUESTION M√âDICALE",
encouraging:["EXCELLENT ! üåü","PARFAIT ! üéØ","BRILLANT ! üí°","EXCEPTIONNEL ! üèÜ","INCROYABLE ! ‚≠ê","BON TRAVAIL ! üëè","BIEN JOU√â ! üéâ","FANTASTIQUE ! üöÄ","SUPERBE ! üí™","BRAVO ! ‚úÖ"],
saveLoaded:"Bon retour, Dr. ",
enterName:"Entrez votre nom pour commencer"
}
};

// ============================================================
// SAVE SYSTEM
// ============================================================
const SaveSystem = {
  KEY: 'dq_save_v5',
  save(data) {
    try {
      localStorage.setItem(this.KEY, JSON.stringify(data));
      return true;
    } catch(e) {
      console.warn('Save failed:', e);
      return false;
    }
  },
  load() {
    try {
      const raw = localStorage.getItem(this.KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e) {
      return null;
    }
  },
  clear() {
    try { localStorage.removeItem(this.KEY); } catch(e) {}
  },
  has() {
    try { return localStorage.getItem(this.KEY) !== null; } catch(e) { return false; }
  }
};

// ============================================================
// ACHIEVEMENTS
// ============================================================
const Achievements = {
  KEY: 'dq_ach_v2',
  unlocked: [],
  check(id) {
    if (this.unlocked.includes(id)) return;
    this.unlocked.push(id);
    try { localStorage.setItem(this.KEY, JSON.stringify(this.unlocked)); } catch(e) {}
    this.show(id);
  },
  show(id) {
    const names = {
      firstStep: {en:"First Steps",fr:"Premiers Pas"},
      streak5:   {en:"On Fire!",fr:"En Feu !"},
      streak10:  {en:"Unstoppable!",fr:"Imbattable !"},
      year1:     {en:"Resident",fr:"Interne"},
      year3:     {en:"Senior Resident",fr:"Interne Senior"},
      year7:     {en:"Doctor!",fr:"Docteur !"},
      score1000: {en:"Scholar",fr:"√ârudit"},
      score5000: {en:"Expert",fr:"Expert"}
    };
    const popup = document.getElementById('achPopup');
    document.getElementById('achDesc').textContent = names[id] ? (names[id][g.lang] || id) : id;
    popup.classList.add('show');
    setTimeout(() => popup.classList.remove('show'), 3000);
  },
  load() {
    try {
      const raw = localStorage.getItem(this.KEY);
      if (raw) this.unlocked = JSON.parse(raw);
    } catch(e) {}
  }
};

// ============================================================
// GAME STATE
// ============================================================
const g = {
  canvas: null, ctx: null, W: 0, H: 0,
  cs: 32,
  running: false, paused: false,
  year: 1, level: 1,
  answered: 0,
  score: 0,
  streak: 0,
  maze: [], mazeW: 0, mazeH: 0,
  exit: {x:0, y:0},
  px: 1, py: 1,
  rx: 0, ry: 0,
  tx: 0, ty: 0,
  moving: false,
  moveProgress: 0,
  robotFrame: 0, robotTimer: 0,
  eyeOffset: 0, eyeTimer: 0,
  pool: [],
  exitLocked: true,
  questionShowing: false,
  skipTimer: 0, skipMax: 10000,
  currentCorrectIndex: -1,
  currentExplanation: '',
  particles: [],
  lang: 'en',
  playerName: '',
  graduated: 0,
  lastTime: 0, raf: null,
  cellOffX: 0, cellOffY: 0,
  questionSpots: [],
  triggeredSpots: new Set(),
  isMobile: false
};

// ============================================================
// CANVAS & RESIZE
// ============================================================
function initCanvas() {
  g.canvas = document.getElementById('c');
  g.ctx = g.canvas.getContext('2d');
  g.isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent) || 'ontouchstart' in window;
  resize();
  window.addEventListener('resize', resize);
  window.addEventListener('orientationchange', () => setTimeout(resize, 300));
}

function resize() {
  g.W = window.innerWidth;
  g.H = window.innerHeight;
  g.canvas.width = g.W;
  g.canvas.height = g.H;
  if (g.running) recalcOffsets();
}

function recalcOffsets() {
  // Reserve space for dpad on mobile
  const padX = g.isMobile ? 200 : 0;
  const usableW = g.W - padX;
  g.cellOffX = Math.floor((usableW - g.mazeW * g.cs) / 2);
  g.cellOffY = Math.floor((g.H - g.mazeH * g.cs) / 2) + 10;
  g.rx = cellToPixX(g.px);
  g.ry = cellToPixY(g.py);
  g.tx = g.rx; g.ty = g.ry;
}

// ============================================================
// D-PAD SETUP
// ============================================================
function initDpad() {
  const dpad = document.getElementById('dpad');

  function setupBtn(id, dx, dy) {
    const btn = document.getElementById(id);
    if (!btn) return;

    // Touchstart for immediate response
    btn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (!g.running || g.paused || g.questionShowing) return;
      btn.classList.add('pressed');
      tryMove(dx, dy);
    }, {passive: false});

    btn.addEventListener('touchend', (e) => {
      e.preventDefault();
      btn.classList.remove('pressed');
    }, {passive: false});

    // Also support mouse for desktop
    btn.addEventListener('mousedown', (e) => {
      e.preventDefault();
      if (!g.running || g.paused || g.questionShowing) return;
      btn.classList.add('pressed');
      tryMove(dx, dy);
    });
    btn.addEventListener('mouseup', () => btn.classList.remove('pressed'));
  }

  setupBtn('dUp',    0, -1);
  setupBtn('dDown',  0,  1);
  setupBtn('dLeft', -1,  0);
  setupBtn('dRight', 1,  0);

  // Show dpad when game starts
  dpad.classList.add('hidden');
}

function showDpad() {
  document.getElementById('dpad').classList.remove('hidden');
}

function hideDpad() {
  document.getElementById('dpad').classList.add('hidden');
}

// ============================================================
// MAZE GENERATION
// ============================================================
function genMaze() {
  // Reserve dpad area on mobile (left 180px)
  const padX = g.isMobile ? 190 : 0;
  const usableW = g.W - padX;

  const base = 19 + (g.year - 1) * 2 + (g.level - 1);
  let w = Math.min(base, Math.floor((usableW - 40) / g.cs));
  let h = Math.min(base, Math.floor((g.H - 120) / g.cs));
  if (w < 9) w = 9;
  if (h < 9) h = 9;
  const mw = w % 2 === 0 ? w - 1 : w;
  const mh = h % 2 === 0 ? h - 1 : h;
  g.mazeW = mw; g.mazeH = mh;

  const maze = Array.from({length: mh}, () => new Array(mw).fill(1));

  const carve = (x, y) => {
    maze[y][x] = 0;
    const dirs = [[0,-2],[2,0],[0,2],[-2,0]].sort(() => Math.random() - 0.5);
    for (const [dx, dy] of dirs) {
      const nx = x + dx, ny = y + dy;
      if (nx > 0 && nx < mw-1 && ny > 0 && ny < mh-1 && maze[ny][nx] === 1) {
        maze[y + dy/2][x + dx/2] = 0;
        carve(nx, ny);
      }
    }
  };
  carve(1, 1);

  // Extra loops
  for (let i = 0; i < Math.floor(mw * mh * 0.03); i++) {
    const rx = 1 + Math.floor(Math.random() * (mw - 2));
    const ry = 1 + Math.floor(Math.random() * (mh - 2));
    if (rx % 2 === 0 && ry % 2 === 0) maze[ry][rx] = 0;
  }

  g.exit.x = mw - 2; g.exit.y = mh - 2;
  maze[g.exit.y][g.exit.x] = 0;

  g.questionSpots = [];
  g.triggeredSpots = new Set();
  const pathCells = [];
  for (let y = 0; y < mh; y++) for (let x = 0; x < mw; x++) {
    if (maze[y][x] === 0 && !(x===1 && y===1) && !(x===g.exit.x && y===g.exit.y))
      pathCells.push({x, y});
  }
  pathCells.sort(() => Math.random() - 0.5);
  const numSpots = 12 + g.year * 2;
  for (let i = 0; i < Math.min(numSpots, pathCells.length); i++)
    g.questionSpots.push(pathCells[i]);

  g.maze = maze;
  recalcOffsets();
}

// ============================================================
// LOAD LEVEL
// ============================================================
function loadLevel() {
  genMaze();
  g.px = 1; g.py = 1;
  g.rx = cellToPixX(1); g.ry = cellToPixY(1);
  g.tx = g.rx; g.ty = g.ry;
  g.moving = false; g.moveProgress = 0;
  g.answered = 0; g.exitLocked = true;
  g.particles = [];
  updateDots();
  updateHUD();
  const yearKey = 'year' + g.year;
  const src = DB[yearKey] || DB.year1;
  g.pool = [...src.qs].sort(() => Math.random() - 0.5);
  showNarrator(t('narrator3') + g.year + t('narrator4') + g.level + ' ‚Äî ' + t('narrator1'));
}

function cellToPixX(x) { return g.cellOffX + x * g.cs + 2; }
function cellToPixY(y) { return g.cellOffY + y * g.cs + 2; }

// ============================================================
// PLAYER MOVEMENT
// ============================================================
const MOVE_SPEED = 0.18;

function tryMove(dx, dy) {
  if (g.moving || g.questionShowing || g.paused || !g.running) return;
  const nx = g.px + dx, ny = g.py + dy;
  if (nx < 0 || ny < 0 || nx >= g.mazeW || ny >= g.mazeH) return;
  if (g.maze[ny][nx] !== 0) return;
  g.px = nx; g.py = ny;
  g.tx = cellToPixX(nx); g.ty = cellToPixY(ny);
  g.moving = true; g.moveProgress = 0;
}

function updateMovement(dt) {
  if (!g.moving) return;
  g.moveProgress += MOVE_SPEED * (dt / 16.67);
  if (g.moveProgress >= 1) {
    g.moveProgress = 1; g.moving = false;
    g.rx = g.tx; g.ry = g.ty;
    checkCell();
  } else {
    g.rx = lerp(g.rx, g.tx, g.moveProgress);
    g.ry = lerp(g.ry, g.ty, g.moveProgress);
  }
}

function lerp(a, b, t) { return a + (b - a) * t; }

function checkCell() {
  if (g.px === g.exit.x && g.py === g.exit.y) {
    if (!g.exitLocked) { levelComplete(); return; }
    else showNarrator(t('exitLocked'));
  }
  const key = g.px + ',' + g.py;
  if (!g.triggeredSpots.has(key)) {
    const spot = g.questionSpots.find(s => s.x === g.px && s.y === g.py);
    if (spot && g.answered < 3) {
      g.triggeredSpots.add(key);
      setTimeout(() => showQuestion(), 200);
    }
  }
}

// ============================================================
// QUESTION SYSTEM ‚Äî FIXED
// ============================================================
function showQuestion() {
  if (g.answered >= 3 || g.questionShowing) return;
  if (g.pool.length === 0) {
    const yearKey = 'year' + g.year;
    g.pool = [...DB[yearKey].qs].sort(() => Math.random() - 0.5);
  }
  const q = g.pool.pop();
  g.questionShowing = true;

  // DISABLE DPAD while question showing
  document.getElementById('dpad').style.pointerEvents = 'none';
  document.getElementById('dpad').style.opacity = '0.3';

  const lang = g.lang;
  const yearKey = 'year' + g.year;
  document.getElementById('qTitle').textContent = t('questionTitle');
  document.getElementById('qBadge').textContent = DB[yearKey].label[lang];
  document.getElementById('qText').textContent = lang === 'en' ? q.en : q.fr;

  // Shuffle options
  const options = lang === 'en' ? q.a.en : q.a.fr;
  const indices = [...Array(options.length).keys()];
  for (let i = indices.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [indices[i], indices[j]] = [indices[j], indices[i]];
  }
  const shuffled = indices.map(i => options[i]);
  g.currentCorrectIndex = indices.indexOf(q.ca);
  g.currentExplanation = q.exp ? (lang === 'en' ? q.exp.en : q.exp.fr) : '';

  const opts = document.getElementById('qOpts');
  opts.innerHTML = '';
  const labels = ['A', 'B', 'C', 'D'];
  shuffled.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'q-btn';
    btn.textContent = labels[i] + '. ' + opt;
    btn.setAttribute('data-index', i);
    // Use both onclick and ontouchend for maximum compatibility
    btn.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      handleAnswer(i, btn, opts);
    };
    opts.appendChild(btn);
  });

  document.getElementById('qFb').textContent = '';
  document.getElementById('qFb').className = 'q-feedback';
  document.getElementById('qExplanation').textContent = '';
  document.getElementById('qExplanation').classList.remove('show');
  document.getElementById('skipBtn').textContent = t('skip');
  document.getElementById('skipBtn').disabled = false;
  g.skipTimer = g.skipMax;
  document.getElementById('skipBar').style.width = '100%';
  document.getElementById('qPanel').classList.add('active');
  spawnParticles(g.W / 2, g.H / 2, '#00e5ff', 8);
}

function handleAnswer(selected, clickedBtn, optsEl) {
  if (clickedBtn.disabled) return;
  // Disable all buttons immediately
  Array.from(optsEl.children).forEach(b => { b.disabled = true; });

  const fb = document.getElementById('qFb');
  const expEl = document.getElementById('qExplanation');

  if (selected === g.currentCorrectIndex) {
    // CORRECT
    clickedBtn.classList.add('correct');
    fb.className = 'q-feedback correct';
    fb.textContent = t('correct');
    g.answered++;
    g.score += 100 * g.year + (g.streak * 10);
    g.streak++;

    if (g.streak >= 5) Achievements.check('streak5');
    if (g.streak >= 10) Achievements.check('streak10');
    if (g.score >= 1000) Achievements.check('score1000');
    if (g.score >= 5000) Achievements.check('score5000');

    // Show big encouraging message
    showEncouragement();
    spawnParticles(g.W / 2, g.H / 2, '#2ecc71', 20);
    updateDots();
    updateHUD();

    setTimeout(() => {
      closeQuestion();
      if (g.answered >= 3) {
        g.exitLocked = false;
        showNarrator(t('exitOpen'));
        spawnParticles(g.cellOffX + g.exit.x * g.cs + g.cs/2, g.cellOffY + g.exit.y * g.cs + g.cs/2, '#2ecc71', 30);
        autoSave();
      }
    }, 1800);
  } else {
    // WRONG
    clickedBtn.classList.add('wrong');
    // Highlight correct answer
    Array.from(optsEl.children).forEach((btn, i) => {
      if (i === g.currentCorrectIndex) btn.classList.add('correct');
    });
    fb.className = 'q-feedback wrong';
    fb.textContent = t('wrong');
    g.score = Math.max(0, g.score - 20);
    g.streak = 0;
    updateHUD();

    // ALWAYS show explanation on wrong answer
    if (g.currentExplanation) {
      expEl.innerHTML = 'üí° <strong>' + (g.lang === 'en' ? 'Explanation: ' : 'Explication : ') + '</strong>' + g.currentExplanation;
      expEl.classList.add('show');
    }

    spawnParticles(g.rx + g.cs/2, g.ry + g.cs/2, '#e74c3c', 12);
    setTimeout(() => closeQuestion(), 3500);
  }
}

function showEncouragement() {
  const msgs = t('encouraging');
  const msg = msgs[Math.floor(Math.random() * msgs.length)];
  const el = document.getElementById('encourageMsg');
  el.textContent = msg;
  el.classList.remove('fade');
  el.classList.add('pop');
  setTimeout(() => {
    el.classList.add('fade');
    setTimeout(() => {
      el.classList.remove('pop', 'fade');
    }, 400);
  }, 1200);
}

function closeQuestion() {
  document.getElementById('qPanel').classList.remove('active');
  g.questionShowing = false;
  g.skipTimer = 0;
  g.currentCorrectIndex = -1;
  g.currentExplanation = '';
  // Re-enable dpad
  document.getElementById('dpad').style.pointerEvents = 'auto';
  document.getElementById('dpad').style.opacity = '0.85';
}

// ============================================================
// SAVE SYSTEM
// ============================================================
function autoSave() {
  const data = {
    playerName: g.playerName,
    year: g.year,
    level: g.level,
    score: g.score,
    answered: g.answered,
    streak: g.streak,
    lang: g.lang,
    ts: Date.now()
  };
  if (SaveSystem.save(data)) showSaveIndicator();
}

function showSaveIndicator() {
  const el = document.getElementById('saveIndicator');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// ============================================================
// LEVEL / YEAR COMPLETE
// ============================================================
function levelComplete() {
  if (g.level < 7) {
    g.level++;
    loadLevel();
    spawnParticles(g.W/2, g.H/2, '#f1c40f', 30);
    if (g.level === 2 && g.year === 1) Achievements.check('firstStep');
    autoSave();
  } else {
    yearComplete();
  }
}

function yearComplete() {
  g.running = false;
  hideDpad();
  const panel = document.getElementById('yearComp');
  const tl = document.getElementById('ycTitle');
  const tx = document.getElementById('ycText');
  const btn = document.getElementById('nextYrBtn');
  if (g.year === 7) {
    tl.textContent = g.lang === 'en' ? 'üéì CONGRATULATIONS!' : 'üéì F√âLICITATIONS !';
    tx.textContent = g.lang === 'en'
      ? 'You have completed ALL 7 years! You are now a Doctor!'
      : 'Vous avez termin√© les 7 ann√©es ! Vous √™tes Docteur !';
    btn.textContent = g.lang === 'en' ? 'üìú RECEIVE CERTIFICATE' : 'üìú RECEVOIR LE CERTIFICAT';
    Achievements.check('year7');
  } else {
    tl.textContent = t('year') + ' ' + g.year + ' ' + t('yearComplete');
    tx.textContent = t('yearComp1') + g.year + t('yearComp2');
    btn.textContent = t('nextYear') + ' ‚Äî ' + (g.lang === 'en' ? 'Year ' : 'Ann√©e ') + (g.year + 1);
    if (g.year === 1) Achievements.check('year1');
    if (g.year === 3) Achievements.check('year3');
  }
  panel.classList.add('active');
  autoSave();
}

function showCertificate() {
  document.getElementById('yearComp').classList.remove('active');
  document.getElementById('certScreen').classList.add('active');
  document.getElementById('certSchool').textContent = t('certSchool');
  document.getElementById('certPresents').textContent = t('certPresents');
  document.getElementById('certTL').textContent = t('certTitle');
  document.getElementById('certBody').textContent = t('certBody');
  document.getElementById('sigDean').textContent = t('sigDean');
  document.getElementById('sigReg').textContent = t('sigReg');
  const name = (g.playerName || 'GRADUATE').toUpperCase();
  document.getElementById('certName').textContent = 'DR. ' + name;
  const now = new Date();
  document.getElementById('certDate').textContent = now.toLocaleDateString(
    g.lang === 'en' ? 'en-US' : 'fr-FR',
    {year:'numeric', month:'long', day:'numeric'}
  );
  try {
    const grad = parseInt(localStorage.getItem('dq_grad') || '0') + 1;
    localStorage.setItem('dq_grad', grad);
    document.getElementById('gradCount').textContent = grad;
  } catch(e) {}
}

// ============================================================
// PARTICLES
// ============================================================
function spawnParticles(x, y, color, count) {
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 1 + Math.random() * 4;
    g.particles.push({
      x, y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 1,
      life: 1,
      decay: 0.018 + Math.random() * 0.025,
      size: 2 + Math.random() * 5,
      color
    });
  }
}

function updateParticles(dt) {
  const f = dt / 16.67;
  g.particles = g.particles.filter(p => {
    p.x += p.vx * f; p.y += p.vy * f; p.vy += 0.12 * f;
    p.life -= p.decay * f;
    return p.life > 0;
  });
}

function drawParticles() {
  const ctx = g.ctx;
  g.particles.forEach(p => {
    ctx.save();
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  });
}

// ============================================================
// ROBOT DRAWING
// ============================================================
function drawRobot(ctx, x, y, size) {
  const s = size;
  const cx = x + s/2, cy = y + s/2;
  g.robotTimer++;
  if (g.robotTimer % 18 === 0) g.robotFrame = (g.robotFrame + 1) % 4;
  const bobY = Math.sin(g.robotFrame * Math.PI / 2) * 1.5;
  const legSwing = Math.sin(g.robotFrame * Math.PI / 2) * 3;
  g.eyeTimer++;
  if (g.eyeTimer > 90 + Math.random() * 60) { g.eyeOffset = Math.random() < 0.5 ? 1 : -1; g.eyeTimer = 0; }
  const ey = g.eyeOffset;
  ctx.save();
  ctx.translate(cx, cy + bobY);
  ctx.save();
  ctx.globalAlpha = 0.3;
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.ellipse(0, s*.38, s*.28, s*.08, 0, 0, Math.PI*2); ctx.fill();
  ctx.restore();
  ctx.fillStyle = '#1a6090';
  ctx.fillRect(-s*.19+legSwing*.5, s*.2, s*.13, s*.22);
  ctx.fillRect( s*.06-legSwing*.5, s*.2, s*.13, s*.22);
  ctx.fillStyle = '#0d4060';
  ctx.fillRect(-s*.22+legSwing*.5, s*.38, s*.18, s*.07);
  ctx.fillRect( s*.04-legSwing*.5, s*.38, s*.18, s*.07);
  const grad = ctx.createLinearGradient(-s*.28,-s*.15,s*.28,s*.22);
  grad.addColorStop(0,'#4a9fd4'); grad.addColorStop(.5,'#2a7ab4'); grad.addColorStop(1,'#1a5a94');
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.roundRect(-s*.28,-s*.15,s*.56,s*.38,s*.06); ctx.fill();
  ctx.fillStyle = 'rgba(255,255,255,0.15)';
  ctx.beginPath(); ctx.roundRect(-s*.24,-s*.12,s*.2,s*.1,s*.03); ctx.fill();
  ctx.fillStyle = '#e74c3c';
  ctx.fillRect(-s*.04,s*.0,s*.08,s*.16);
  ctx.fillRect(-s*.1,s*.05,s*.2,s*.06);
  ctx.fillStyle = '#1a6090';
  ctx.save(); ctx.translate(-s*.3,-s*.05); ctx.rotate(Math.sin(g.robotFrame*Math.PI/2)*.25);
  ctx.fillRect(-s*.1,0,s*.1,s*.25);
  ctx.fillStyle = '#0d4060'; ctx.beginPath(); ctx.arc(-s*.05,s*.28,s*.08,0,Math.PI*2); ctx.fill();
  ctx.restore();
  ctx.save(); ctx.translate(s*.3,-s*.05); ctx.rotate(-Math.sin(g.robotFrame*Math.PI/2)*.25);
  ctx.fillRect(0,0,s*.1,s*.25);
  ctx.fillStyle = '#0d4060'; ctx.beginPath(); ctx.arc(s*.05,s*.28,s*.08,0,Math.PI*2); ctx.fill();
  ctx.restore();
  ctx.fillStyle = '#1a5a94'; ctx.fillRect(-s*.08,-s*.22,s*.16,s*.09);
  const hg = ctx.createLinearGradient(-s*.25,-s*.48,s*.25,-s*.2);
  hg.addColorStop(0,'#5ab0e0'); hg.addColorStop(1,'#2a80c0');
  ctx.fillStyle = hg; ctx.beginPath(); ctx.roundRect(-s*.25,-s*.48,s*.5,s*.29,s*.08); ctx.fill();
  ctx.fillStyle = '#1a6090'; ctx.fillRect(-s*.08,-s*.52,s*.16,s*.06);
  ctx.beginPath(); ctx.arc(0,-s*.52,s*.06,0,Math.PI*2); ctx.fillStyle = '#f1c40f'; ctx.fill();
  ctx.strokeStyle = '#0a3a60'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(0,-s*.52); ctx.lineTo(0,-s*.62); ctx.stroke();
  const blinkOn = (g.robotTimer % 40 < 35);
  ctx.beginPath(); ctx.arc(0,-s*.64,s*.04,0,Math.PI*2);
  ctx.fillStyle = blinkOn ? '#e74c3c' : '#7a1010'; ctx.fill();
  ctx.fillStyle = '#050512';
  ctx.beginPath(); ctx.roundRect(-s*.18+ey,-s*.4,s*.14,s*.1,s*.03); ctx.fill();
  ctx.beginPath(); ctx.roundRect(s*.04+ey,-s*.4,s*.14,s*.1,s*.03); ctx.fill();
  ctx.fillStyle = '#00e5ff'; ctx.globalAlpha = 0.9;
  ctx.beginPath(); ctx.arc(-s*.11+ey,-s*.35,s*.04,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc( s*.11+ey,-s*.35,s*.04,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha = 0.4;
  ctx.beginPath(); ctx.arc(-s*.11+ey,-s*.35,s*.025,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc( s*.11+ey,-s*.35,s*.025,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha = 1;
  ctx.strokeStyle = '#0a3a60'; ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(-s*.1,-s*.26); ctx.lineTo(-s*.03,-s*.22); ctx.lineTo(s*.03,-s*.22); ctx.lineTo(s*.1,-s*.26);
  ctx.stroke();
  ctx.restore();
}

// ============================================================
// RENDER MAZE
// ============================================================
function drawMaze() {
  const ctx = g.ctx, cs = g.cs;
  const ox = g.cellOffX, oy = g.cellOffY;
  const mw = g.mazeW, mh = g.mazeH;
  const maze = g.maze;

  ctx.fillStyle = '#0a0a14';
  ctx.fillRect(ox, oy, mw*cs, mh*cs);

  for (let y = 0; y < mh; y++) {
    for (let x = 0; x < mw; x++) {
      const px = ox + x*cs, py = oy + y*cs;
      if (maze[y][x] === 1) {
        ctx.fillStyle = '#1a1a30'; ctx.fillRect(px, py, cs, cs);
        ctx.fillStyle = '#141428'; ctx.fillRect(px+1, py+1, cs-2, cs-2);
        ctx.fillStyle = '#222240'; ctx.fillRect(px+1, py+1, cs-2, 1); ctx.fillRect(px+1, py+1, 1, cs-2);
      } else {
        ctx.fillStyle = (x+y)%2===0 ? '#0d0d1c' : '#0f0f1f';
        ctx.fillRect(px, py, cs, cs);
        ctx.strokeStyle = 'rgba(30,30,60,0.4)'; ctx.lineWidth = 0.5;
        ctx.strokeRect(px+.5, py+.5, cs-1, cs-1);
      }
    }
  }

  // Question spots
  g.questionSpots.forEach(sp => {
    const key = sp.x + ',' + sp.y;
    if (g.triggeredSpots.has(key)) return;
    if (g.answered >= 3) return;
    const px = ox + sp.x*cs, py = oy + sp.y*cs;
    const pulse = 0.3 + 0.2 * Math.sin(Date.now() * 0.004);
    ctx.fillStyle = `rgba(52,152,219,${pulse})`;
    ctx.fillRect(px+3, py+3, cs-6, cs-6);
    ctx.fillStyle = `rgba(0,229,255,${pulse+0.2})`;
    ctx.font = `bold ${cs*.45}px monospace`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('?', px+cs/2, py+cs/2+1);
  });
  ctx.textAlign = 'left'; ctx.textBaseline = 'alphabetic';

  // Exit
  const ex = ox + g.exit.x*cs, ey = oy + g.exit.y*cs;
  if (g.exitLocked) {
    const lp = 0.6 + 0.2 * Math.sin(Date.now() * 0.003);
    ctx.fillStyle = `rgba(231,76,60,${lp*0.6})`; ctx.fillRect(ex, ey, cs, cs);
    ctx.strokeStyle = `rgba(231,76,60,${lp})`; ctx.lineWidth = 2; ctx.strokeRect(ex+1, ey+1, cs-2, cs-2);
    ctx.fillStyle = `rgba(231,76,60,${lp+0.1})`;
    ctx.font = `bold ${cs*.5}px monospace`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('üîí', ex+cs/2, ey+cs/2);
  } else {
    const gp = 0.5 + 0.3 * Math.sin(Date.now() * 0.005);
    ctx.fillStyle = `rgba(46,204,113,${gp})`; ctx.fillRect(ex, ey, cs, cs);
    ctx.shadowColor = '#2ecc71'; ctx.shadowBlur = 16;
    ctx.strokeStyle = '#2ecc71'; ctx.lineWidth = 2; ctx.strokeRect(ex+1, ey+1, cs-2, cs-2);
    ctx.shadowBlur = 0;
    ctx.fillStyle = '#fff'; ctx.font = `bold ${cs*.55}px monospace`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('‚ñ∂', ex+cs/2, ey+cs/2);
  }
  ctx.textAlign = 'left'; ctx.textBaseline = 'alphabetic';
}

// ============================================================
// RENDER
// ============================================================
function render() {
  const ctx = g.ctx;
  ctx.clearRect(0, 0, g.W, g.H);
  const bg = ctx.createRadialGradient(g.W/2, g.H*.6, 0, g.W/2, g.H/2, g.W*.8);
  bg.addColorStop(0, '#0d0d1e'); bg.addColorStop(1, '#07070f');
  ctx.fillStyle = bg; ctx.fillRect(0, 0, g.W, g.H);
  if (!g.running) return;
  drawMaze();
  drawParticles();
  drawRobot(ctx, g.rx, g.ry, g.cs - 2);
}

// ============================================================
// GAME LOOP
// ============================================================
function loop(ts) {
  if (!g.running) { g.raf = null; return; }
  const dt = Math.min(100, ts - g.lastTime);
  g.lastTime = ts;
  if (!g.paused) {
    updateMovement(dt);
    updateParticles(dt);
    if (g.questionShowing && g.skipTimer > 0) {
      g.skipTimer -= dt;
      document.getElementById('skipBar').style.width = Math.max(0, g.skipTimer/g.skipMax*100) + '%';
      if (g.skipTimer <= 0) closeQuestion();
    }
  }
  render();
  g.raf = requestAnimationFrame(loop);
}

// ============================================================
// UI HELPERS
// ============================================================
function t(key) { return T[g.lang][key] || T.en[key] || key; }

function showNarrator(txt) {
  const el = document.getElementById('narrator');
  el.textContent = txt; el.style.opacity = '1';
  clearTimeout(el._t);
  el._t = setTimeout(() => { if (el.textContent === txt) el.style.opacity = '0'; }, 4000);
}

function updateHUD() {
  document.getElementById('vYear').textContent = g.year;
  document.getElementById('vLevel').textContent = g.level;
  document.getElementById('vScore').textContent = g.score;
  document.getElementById('vStreak').textContent = g.streak;
  const pct = ((g.year-1)*7 + (g.level-1) + (g.answered/3)) / (7*7) * 100;
  document.getElementById('progFill').style.width = Math.min(100, pct) + '%';
  const sb = document.getElementById('hStreak');
  if (g.streak >= 2) { sb.classList.add('active'); sb.style.display = 'block'; }
  else { sb.classList.remove('active'); sb.style.display = 'none'; }
}

function updateDots() {
  for (let i = 0; i < 3; i++) {
    document.getElementById('d'+i).classList.toggle('lit', i < g.answered);
  }
}

// ============================================================
// START / CONTINUE GAME
// ============================================================
function startNewGame() {
  const input = document.getElementById('playerNameInput');
  g.playerName = input.value.trim() || 'STUDENT';
  g.year = 1; g.level = 1; g.score = 0; g.answered = 0; g.streak = 0;
  launchGame();
}

function continueGame() {
  const saved = SaveSystem.load();
  if (!saved) { startNewGame(); return; }
  const input = document.getElementById('playerNameInput');
  g.playerName = input.value.trim() || saved.playerName || 'STUDENT';
  g.year = saved.year || 1;
  g.level = saved.level || 1;
  g.score = saved.score || 0;
  g.answered = saved.answered || 0;
  g.streak = saved.streak || 0;
  g.lang = saved.lang || g.lang;
  launchGame();
  showNarrator(t('saveLoaded') + g.playerName + '!');
}

function launchGame() {
  document.getElementById('title').style.opacity = '0';
  setTimeout(() => document.getElementById('title').classList.add('hidden'), 500);
  g.running = true; g.paused = false;
  loadLevel();
  g.rx = cellToPixX(g.px); g.ry = cellToPixY(g.py);
  showDpad();
  if (g.raf) cancelAnimationFrame(g.raf);
  g.lastTime = performance.now();
  g.raf = requestAnimationFrame(loop);
  updateSaveInfoDisplay();
}

function updateSaveInfoDisplay() {
  const saved = SaveSystem.load();
  const contBtn = document.getElementById('continueBtn');
  const saveInfo = document.getElementById('saveInfo');
  if (saved) {
    contBtn.style.display = 'block';
    saveInfo.textContent = 'üíæ Dr. ' + (saved.playerName||'?') + ' ‚Äî ' + t('year') + ' ' + saved.year + ' ¬∑ ' + t('level') + ' ' + saved.level + ' ¬∑ ' + t('score') + ': ' + saved.score;
    saveInfo.classList.add('show');
  } else {
    contBtn.style.display = 'none';
    saveInfo.classList.remove('show');
  }
}

// ============================================================
// EVENT LISTENERS
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  initCanvas();
  initDpad();
  Achievements.load();

  try {
    const grad = parseInt(localStorage.getItem('dq_grad') || '0');
    document.getElementById('gradCount').textContent = grad;
  } catch(e) {}

  updateSaveInfoDisplay();

  // Title buttons
  document.getElementById('startBtn').addEventListener('click', startNewGame);
  document.getElementById('continueBtn').addEventListener('click', continueGame);

  document.getElementById('langBtn').addEventListener('click', () => {
    g.lang = g.lang === 'en' ? 'fr' : 'en';
    document.getElementById('langBtn').textContent = t('langBtn');
    document.getElementById('startBtn').textContent = t('startBtn');
    document.getElementById('continueBtn').textContent = t('continueBtn');
    document.getElementById('howBtn').textContent = t('howBtn');
    updateSaveInfoDisplay();
  });

  document.getElementById('howBtn').addEventListener('click', () => alert(t('howToPlay')));

  // Pause
  document.getElementById('pauseBtn').addEventListener('click', () => {
    if (!g.running) return;
    g.paused = !g.paused;
    document.getElementById('pauseMenu').classList.toggle('active', g.paused);
    if (g.paused) {
      document.getElementById('pTitle').textContent = t('paused');
      document.getElementById('resumeBtn').textContent = t('resume');
      document.getElementById('rstBtn').textContent = t('restart');
      document.getElementById('quitBtn').textContent = t('quit');
      document.getElementById('pausePlayerName').textContent = g.playerName || '-';
      document.getElementById('pauseYear').textContent = g.year;
      document.getElementById('pauseLevel').textContent = g.level;
      document.getElementById('pauseScore').textContent = g.score;
    }
  });

  document.getElementById('resumeBtn').addEventListener('click', () => {
    g.paused = false;
    document.getElementById('pauseMenu').classList.remove('active');
  });

  document.getElementById('rstBtn').addEventListener('click', () => {
    g.paused = false;
    document.getElementById('pauseMenu').classList.remove('active');
    loadLevel();
    g.rx = cellToPixX(g.px); g.ry = cellToPixY(g.py);
    if (!g.raf) { g.lastTime = performance.now(); g.raf = requestAnimationFrame(loop); }
  });

  document.getElementById('quitBtn').addEventListener('click', () => {
    autoSave();
    g.running = false; g.paused = false;
    document.getElementById('pauseMenu').classList.remove('active');
    hideDpad();
    document.getElementById('title').classList.remove('hidden');
    document.getElementById('title').style.opacity = '1';
    if (g.raf) { cancelAnimationFrame(g.raf); g.raf = null; }
    updateSaveInfoDisplay();
  });

  // Skip button
  document.getElementById('skipBtn').addEventListener('click', () => closeQuestion());

  // Year complete
  document.getElementById('nextYrBtn').addEventListener('click', () => {
    document.getElementById('yearComp').classList.remove('active');
    if (g.year === 7) { showCertificate(); return; }
    g.year++; g.level = 1; g.answered = 0; g.streak = 0; g.running = true;
    loadLevel();
    g.rx = cellToPixX(g.px); g.ry = cellToPixY(g.py);
    showDpad();
    if (g.raf) cancelAnimationFrame(g.raf);
    g.lastTime = performance.now();
    g.raf = requestAnimationFrame(loop);
  });

  document.getElementById('dlBtn').addEventListener('click', () => {
    alert(g.lang === 'en'
      ? 'üéì Certificate saved! You are officially Dr. ' + g.playerName + '!'
      : 'üéì Certificat enregistr√© ! Vous √™tes officiellement Dr. ' + g.playerName + ' !');
  });

  document.getElementById('playAgainBtn').addEventListener('click', () => {
    SaveSystem.clear();
    document.getElementById('certScreen').classList.remove('active');
    document.getElementById('title').classList.remove('hidden');
    document.getElementById('title').style.opacity = '1';
    document.getElementById('playerNameInput').value = '';
    updateSaveInfoDisplay();
  });

  // Keyboard controls
  document.addEventListener('keydown', (e) => {
    if (g.questionShowing) {
      if (e.key === 'Escape') closeQuestion();
      return;
    }
    if (!g.running || g.paused) return;
    switch (e.key) {
      case 'ArrowUp':    case 'w': case 'W': e.preventDefault(); tryMove(0,-1); break;
      case 'ArrowDown':  case 's': case 'S': e.preventDefault(); tryMove(0, 1); break;
      case 'ArrowLeft':  case 'a': case 'A': e.preventDefault(); tryMove(-1,0); break;
      case 'ArrowRight': case 'd': case 'D': e.preventDefault(); tryMove(1, 0); break;
      case 'Escape': case 'p': case 'P':
        g.paused = !g.paused;
        document.getElementById('pauseMenu').classList.toggle('active', g.paused);
        break;
    }
  });

  // Auto-save every 30s while playing
  setInterval(() => { if (g.running && !g.paused && g.answered > 0) autoSave(); }, 30000);

  // Initial render
  render();
});
</script>
</body>
</html>
